<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>9.diff算法(patch) | ypf的博客</title><meta name="author" content="ypf"><meta name="copyright" content="ypf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="为何操作dom性能差？我们知道vue每次数据变化，在更新dom前都会进行diff对比，再进行操作dom，这极大的提高的页面性能效率，为什么操作dom就浪费性能，操作数据就不浪费？我们来看个案例： 案例一1234567891011console.time()for(var i&amp;#x3D;0;i&amp;lt;10000"><link rel="shortcut icon" href="/ypf-blog/img/favicon.png"><link rel="canonical" href="https://mystylemylife.github.io/ypf-blog/2023/09/28/vue2%E6%BA%90%E7%A0%81/9.diff%E7%AE%97%E6%B3%95(patch)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.staticfile.net/font-awesome/6.7.1/css/all.min.css"><script>const GLOBAL_CONFIG = {
  root: '/ypf-blog/',
  algolia: undefined,
  localSearch: {"path":"/ypf-blog/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"9.diff算法(patch)",isPost:!0,isHome:!1,isHighlightShrink:void 0,isToc:!0,postUpdate:"2023-10-30 10:49:36"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/css/atom-one-dark.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAAXNSR0IArs4c6QAABhdJREFUeF7tnW9MlmUUxg+ELHGtTEWCRmt+sD9SCYrYIGtJpmkuR0NMIh2mgIEaBEaJaAhCooOAbBQGtgHhWolbm9CXam0xy3IUNSotczkSRHOrJtBulnPo8/g+HN4X33O47i984Dn3fa7r957z3Hvu94/PrIXPDhCGWgd8AFgt20FhAKybLwAr5wvAAKzdAeX6cA8GYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoG4OvngK+vL5VvzyR//3GWSXxx5Bi9U/+RRxNMevoJio58wHKNjs4TtGvvfo+uP9LJvbqC/cf50eH6CgoYf6OlzoGBAUrK2Erfdx4fqQ+W8dOn3UF1Zfnk4+Nj+f8j33bQupxCj6ztrkm9GrAROTcijMq2Z9rq7T7bSwtWpLvLjyHzfPxeGU2aeLPl3H//8y/FLk8j89ebh9cDNuaV5m2gmDkzbX1sPNhCJVV1bvU5c91Kin8y1nbODXml9HnbN25d0xOTiQDspFXHp+TSL7/+7haP7gwNoYaqAtvW3PpZG+XseMMta3l6EhGAjQlREWGDGy67cbqrmxYnbXSLX4fq9lDgpImWc507f4FiE9ZTf3+/W9by9CRiABsjXt+SQfOiwm092dfYTBX73h+RZ+mr4ykxbpHtpm7Vpm3U/sPPI1pjNINFAXbVqvv7B+ip5Cw69UcXy8PQkCBqeqvItjV74l7PSnQYQaIAD7bq8BlU/lqWrcTfTp2mZckvDcOCy5d+WLOLgqdOtox15y2AlRwzSBxgo7Pk1XR6eG6ErWTTpk27Hs5Ym7iMkhOWWoaYzhD3fDaZF4+0IRKwn98N1NpQafsApK+vj5Y89yJ1nelxxCM4aAp9UF1Cvr7WDzQq322imoaDjubytotEAnbSqjuPn6SE1FxHfh+oLqbQ4KmW1w5nHkeLjfJFYgEbn4pfSadHHrRv1ebhh9kYXWusil9CqUlxlpdcvNhHixIzqKf3/Chjcd9yogG7atUG0IIVL9C5vy5YOjb51lvoUO0e29acv7uamg9/6j63r8NMogEbvyJn3ksVBfa75i+/bqe03GJLa/eXbyNzoGA1vjrWQWuzvfsgwcnrRTxgI7Lo5fX0aPRsW71rsgroaPuPQ/6/eH405W1aYxkj5SBhzAA2rbqlvoImBIy31Hymp5cef+byiZM5fjTHkObBidWQcpAwZgAbobPvv4cqC7NtNb9Ze4De/v/NAaVbN1KMzSG+pIOEMQXYiC3cnEbzYyJtd8RmwxUSNIVqy/Itr5F2kDDmALtq1W1Hv6PbgwPptsCrH0ead4dIO0gYc4CN4Fn33U1VRTlOtA+5pqm5lXZW1g47ztsDVOyirzR5R04qxT40x7H3Ug8SnAhUCdi8G7OloYJumhDg0gPJBwkuxWn+5bPwsLto787NLj2QfJDgUpxmwEZ8QXYKPTYvytaHn06cpOUpzg4knJjpjdeobNGXjDat+pPGSssHIOZIceFK2QcJTl5QqgEbA2p2b6EZ06dd5cWf3WcHAWsfAKycMAADsGwH0KKV/8Q7AAOw7BblInvcg1XjJf2/AI4WjRatuobRolXjRYtWjheAAVi6A9hkYZMl/TV8zfyxyVKNF/dg5XgBGIClO2A+7WA+9XDlMN/jsXS1/bf2SNd9KX/192AtoLg6AJjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpoAzHVOSBwACwHFTROAuc4JiQNgIaC4aQIw1zkhcQAsBBQ3TQDmOickDoCFgOKmCcBc54TEAbAQUNw0AZjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpoAzHVOSBwACwHFTROAuc4JiQNgIaC4aQIw1zkhcQAsBBQ3TQDmOickDoCFgOKmCcBc54TEAbAQUNw0AZjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpr/AdetiMf12lDxAAAAAElFTkSuQmCC" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/ypf-blog/archives/"><div class="headline">文章</div><div class="length-num">81</div></a><a href="/ypf-blog/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/ypf-blog/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ypf-blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> gwy</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/ypf-blog/categories/gwy/LFTT/"><span>LFTT</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/ypf-blog/" title="ypf的博客"><span class="site-name">ypf的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ypf-blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> gwy</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/ypf-blog/categories/gwy/LFTT/"><span>LFTT</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">9.diff算法(patch)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-28T01:56:59.577Z" title="发表于 2023-09-28 09:56:59">2023-09-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-30T02:49:36.311Z" title="更新于 2023-10-30 10:49:36">2023-10-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/ypf-blog/categories/vue2%E6%BA%90%E7%A0%81/">vue2源码</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><h2 id="为何操作dom性能差？"><a href="#为何操作dom性能差？" class="headerlink" title="为何操作dom性能差？"></a>为何操作dom性能差？</h2><p>我们知道vue每次数据变化，在更新dom前都会进行diff对比，再进行操作dom，这极大的提高的页面性能效率，为什么操作dom就浪费性能，操作数据就不浪费？我们来看个案例：</p><h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>()<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++)&#123;<br>    <span class="hljs-keyword">var</span> obj=&#123;&#125;<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>()<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>()<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000000</span>;i++)&#123;<br>    <span class="hljs-keyword">var</span> el=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>)<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>()<br></code></pre></td></tr></table></figure><p>结果如下：</p><p>上面结果大概相差了16倍。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/demo1.jpg" width="50%"></p><h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>()<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)&#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span>=i<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>()<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>()<br><span class="hljs-keyword">let</span> num=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)&#123;<br>    num=i<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span>=num<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>()<br></code></pre></td></tr></table></figure><p>结果如下：</p><p>上面结果大概相差了<strong>80倍</strong>，如果涉及到更复杂的dom操作，相差更多。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/demo2.jpg" width="50%"></p><h2 id="patch比对"><a href="#patch比对" class="headerlink" title="patch比对"></a>patch比对</h2><p>我们先看个案例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/vue/2.7.14/vue.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;script src=&quot;./dist/vue.js&quot;&gt;&lt;/script&gt; --&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span></span><br><span class="hljs-tag">        <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;&#123;color:&#x27;red&#x27;,&#x27;font-size&#x27;:a===3?&#x27;17px&#x27;:&#x27;12px&#x27;&#125;&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;test&quot;</span></span><br><span class="hljs-tag">      &gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;&#123;a&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">el</span>: <span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="language-javascript">      <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">        &#125;;</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">    &#125;);</span><br><span class="language-javascript">    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;</span><br><span class="language-javascript">      vm.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>;</span><br><span class="language-javascript">    &#125;, <span class="hljs-number">1000</span>);</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/vue.gif" width="50%"><p>我们更改了样式属性以及data，运行发现，<br><strong>属性只有style变更，dom只有指定节点变更，其他dom都不变。这就是vue diff的强大之处。</strong></p><p>因为我们自己的vue还没有实现模版变量判断等语法，所以我们直接通过下面图例进行<code>vue diff</code>讲解。</p><h3 id="回忆"><a href="#回忆" class="headerlink" title="回忆"></a>回忆</h3><p>我们回忆下之前讲解的，每次数据改变时候，都会触发watcher<code>（vm._update(vm._render())）</code>，我们知道</p><ul><li><code>vm._render()</code>用来生成虚拟dom</li><li><code>vm._update()</code>用来渲染真实dom的</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs js"><br>src/index.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Vue</span>(<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_init</span>(options);<br>  &#125;<br>src/init.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) &#123;<br>      <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>      <span class="hljs-comment">// vm.$options = options;</span><br>      <span class="hljs-comment">// 将用户传入的options和全局的options做合并</span><br>      vm.<span class="hljs-property">$options</span> = <span class="hljs-title function_">mergeOptions</span>(vm.<span class="hljs-property">constructor</span>.<span class="hljs-property">options</span>, options);<br>      <span class="hljs-comment">// 说明：初始化生命周期</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;%c生命周期：beforeCreate&quot;</span>, <span class="hljs-string">&quot;color: red&quot;</span>);<br>      <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">&quot;beforeCreate&quot;</span>);<br>      <span class="hljs-comment">// 初始化状态</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupInfo</span>(<span class="hljs-string">&quot;初始化state，包括data、computed、methods、watch等&quot;</span>)<br>      <span class="hljs-title function_">initState</span>(vm);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupInfoEnd</span>()<br>      <span class="hljs-comment">// 说明：初始化生命周期</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;%c生命周期：created&quot;</span>, <span class="hljs-string">&quot;color: red&quot;</span>);<br>      <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">&quot;created&quot;</span>);<br>      <span class="hljs-comment">// 挂载模版</span><br>      <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>) &#123;<br>        vm.$mount(vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>);<br>      &#125;<br>    &#125;;<br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) &#123;<br>      <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>      <span class="hljs-keyword">const</span> options = vm.<span class="hljs-property">$options</span>;<br>      el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(el);<br>      vm.<span class="hljs-property">$el</span> = el; <span class="hljs-comment">// 存储当前组件的根元素，用于后续的vdom转换真实dom操作</span><br>      <span class="hljs-comment">// 默认先会查找有没有render方法，没有render会采用template，template也没有就用el中的内容</span><br>      <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">render</span>) &#123;<br>        <span class="hljs-comment">// 对模版进行编译</span><br>        <span class="hljs-keyword">let</span> template = options.<span class="hljs-property">template</span>;<br>        <span class="hljs-keyword">if</span> (!template &amp;&amp; el) &#123;<br>          template = el.<span class="hljs-property">outerHTML</span>;<br>        &#125;<br>        <span class="hljs-keyword">const</span> render = <span class="hljs-title function_">compileToFunction</span>(template);<br>        options.<span class="hljs-property">render</span> = render;<br>      &#125;<br>      <span class="hljs-comment">// 挂载组件（主要用到_update和_render方法）</span><br>      <span class="hljs-title function_">mountComponent</span>(vm, el);<br>    &#125;;<br>  &#125;<br>src/lifecycle.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span>(<span class="hljs-params">vm, el</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;%c生命周期：beforeMount&quot;</span>, <span class="hljs-string">&quot;color: red&quot;</span>);<br>    <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">&quot;beforeMount&quot;</span>);<br>    <span class="hljs-comment">// render--&gt;vnode--&gt;真实dom</span><br>    <span class="hljs-comment">// 1.调用vm._render函数，生成虚拟dom  2.调用vm._update,将虚拟dom转换成真实dom</span><br>    <span class="hljs-comment">// vm._update(vm._render());</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateComponent</span> = (<span class="hljs-params"></span>) =&gt; &#123;   <br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;updateComponent&quot;</span>,vm.<span class="hljs-title function_">_render</span>())         <br>      vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>())<br>    &#125;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(vm,updateComponent,<span class="hljs-function">()=&gt;</span>&#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;%c生命周期：updated&quot;</span>, <span class="hljs-string">&quot;color: red&quot;</span>);<br>      <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">&quot;updated&quot;</span>);<br>    &#125;,<span class="hljs-literal">true</span>) <span class="hljs-comment">// 参数1：实例，参数2：更新函数，参数3：渲染函数，参数4：true表示是渲染watcher</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;%c生命周期：mounted&quot;</span>, <span class="hljs-string">&quot;color: red&quot;</span>);<br>    <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">&quot;mounted&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">lifecycleMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vnode</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(vnode, <span class="hljs-string">&quot;vnode&quot;</span>);<br>      <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>      vm.<span class="hljs-property">$el</span> = <span class="hljs-title function_">patch</span>(vm.<span class="hljs-property">$el</span>, vnode);<br>    &#125;;<br>  &#125;)<br>src/vdom/patch.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode</span>) &#123;<br>    <span class="hljs-comment">// 渲染</span><br>    <span class="hljs-keyword">const</span> oldElm = oldVnode; <span class="hljs-comment">// div id=&quot;app&quot;</span><br>    <span class="hljs-keyword">const</span> parentElm = oldElm.<span class="hljs-property">parentNode</span>; <span class="hljs-comment">// body</span><br>    <span class="hljs-keyword">let</span> el = <span class="hljs-title function_">createElm</span>(vnode); <span class="hljs-comment">// 创建真实dom</span><br>    parentElm.<span class="hljs-title function_">insertBefore</span>(el, oldElm.<span class="hljs-property">nextSibling</span>); <span class="hljs-comment">// 将创建的真实dom插入到老的dom的后面</span><br>    parentElm.<span class="hljs-title function_">removeChild</span>(oldElm); <span class="hljs-comment">// 删除老的dom</span><br>    <span class="hljs-keyword">return</span> el;  <br>  &#125;<br></code></pre></td></tr></table></figure><p>上面我简单抽取了几个文件，直接描述了渲染vdom的流程。</p><ul><li>第一次加载的时候通过$mount,生成了存储当前组件根元素真实的dom节点，<code>vm.$el = el</code>，然后执行<code>mountComponent</code>将组件挂载到el下。</li><li>挂载过程主要初始化了watcher<code>（vm._update(vm._render())）</code></li><li><code>vm._update(）</code>执行了patch方法，里面就是通过<code>createElm(vnode)</code>创建真实dom，同时更新<code>vm.$el = patch(vm.$el, vnode);</code></li><li>后面数据变化会执行watcher队列，重新触发<code>vm._update(vm._render())</code></li></ul><h3 id="第一次渲染"><a href="#第一次渲染" class="headerlink" title="第一次渲染"></a>第一次渲染</h3><ul><li>Vue第一次的渲染，<strong>比单纯创建dom元素要效率低</strong>，因为通过执行了一大堆生成vdom逻辑，才生成了真实的dom(即上面的patch函数中createElm)。</li><li>vue的高效体现在响应式数据变化的虚拟dom对比组件依赖的数据收到响应式数据的影响时，重新调用render函数创建虚拟dom树，用新旧虚拟dom树比较，vue会找到最小更新量，然后更新必要的虚拟dom节点，最后修改对应的真实dom。这样就保证了对真实dom达到最小的变动。所以要改造patch函数，因为现在每次更新都相当于第一次创建。</li></ul><h3 id="更新进行patch对比"><a href="#更新进行patch对比" class="headerlink" title="更新进行patch对比"></a>更新进行patch对比</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js">修改src/lifecycle.<span class="hljs-property">js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">lifecycleMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vnode</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(vnode, <span class="hljs-string">&quot;vnode&quot;</span>);<br>    <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-comment">// 1.增加判断</span><br>    <span class="hljs-keyword">const</span> prevVnode = vm.<span class="hljs-property">_vnode</span>; <span class="hljs-comment">// 保存上一次的vnode</span><br>    vm.<span class="hljs-property">_vnode</span> = vnode; <span class="hljs-comment">// 保存当前的vnode</span><br>    <span class="hljs-keyword">if</span> (!prevVnode) &#123;<br>      <span class="hljs-comment">// 说明是初次渲染</span><br>      vm.<span class="hljs-property">$el</span> = <span class="hljs-title function_">patch</span>(vm.<span class="hljs-property">$el</span>, vnode); <br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 说明是更新</span><br>      vm.<span class="hljs-property">$el</span> = <span class="hljs-title function_">patch</span>(prevVnode, vnode);<br>    &#125;<br>  &#125;;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs js">修改src/vdom/patch.<span class="hljs-property">js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, vnode</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(oldVnode, vnode, <span class="hljs-string">&quot;patch&quot;</span>)<br>  <span class="hljs-comment">// 判断是更新还是第一次渲染，第一次传的是真实的dom节点$el,后面更新传递的是虚拟dom</span><br>  <span class="hljs-keyword">const</span> isRealElement = oldVnode.<span class="hljs-property">nodeType</span>;<br>  <span class="hljs-keyword">if</span> (isRealElement) &#123;<br>    <span class="hljs-comment">// 渲染</span><br>    <span class="hljs-keyword">const</span> oldElm = oldVnode; <span class="hljs-comment">// div id=&quot;app&quot;</span><br>    <span class="hljs-keyword">const</span> parentElm = oldElm.<span class="hljs-property">parentNode</span>; <span class="hljs-comment">// body</span><br>    <span class="hljs-keyword">let</span> el = <span class="hljs-title function_">createElm</span>(vnode); <span class="hljs-comment">// 创建真实dom</span><br>    parentElm.<span class="hljs-title function_">insertBefore</span>(el, oldElm.<span class="hljs-property">nextSibling</span>); <span class="hljs-comment">// 将创建的真实dom插入到老的dom的后面</span><br>    parentElm.<span class="hljs-title function_">removeChild</span>(oldElm); <span class="hljs-comment">// 删除老的dom</span><br>    <span class="hljs-keyword">return</span> el;  <br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 更新</span><br>    <span class="hljs-title function_">patchVnode</span>(oldVnode, vnode);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">patchVnode</span>(<span class="hljs-params">oldVnode, vnode</span>) &#123;<br>  <span class="hljs-comment">// 1.比较标签是否一致</span><br>  <span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">tag</span> !== vnode.<span class="hljs-property">tag</span>) &#123;<br>    <span class="hljs-keyword">return</span> oldVnode.<span class="hljs-property">el</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">replaceChild</span>(<span class="hljs-title function_">createElm</span>(vnode), oldVnode.<span class="hljs-property">el</span>);<br>  &#125;<br>  <span class="hljs-comment">// 2.比较文本，此时tag===undefined</span><br>  <span class="hljs-keyword">if</span> (!oldVnode.<span class="hljs-property">tag</span>) &#123;<br>    <span class="hljs-comment">// 文本</span><br>    <span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">text</span> !== vnode.<span class="hljs-property">text</span>) &#123;<br>      <span class="hljs-keyword">return</span> (oldVnode.<span class="hljs-property">el</span>.<span class="hljs-property">textContent</span> = vnode.<span class="hljs-property">text</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 3.标签一致且不是文本，比较属性</span><br>  <span class="hljs-keyword">let</span> el = (vnode.<span class="hljs-property">el</span> = oldVnode.<span class="hljs-property">el</span>); <span class="hljs-comment">// 标签一样，直接复制老的节点</span><br>  <span class="hljs-title function_">updateProperties</span>(vnode, oldVnode.<span class="hljs-property">data</span>); <span class="hljs-comment">// 更新属性</span><br>  <span class="hljs-comment">// 4.比较子节点</span><br>  <span class="hljs-keyword">let</span> oldChildren = oldVnode.<span class="hljs-property">children</span> || [];<br>  <span class="hljs-keyword">let</span> newChildren = vnode.<span class="hljs-property">children</span> || [];<br><br>  <span class="hljs-keyword">if</span> (oldChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; newChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 老的有子节点，新的也有子节点</span><br>    <span class="hljs-title function_">updateChildren</span>(el, oldChildren, newChildren);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 老的有子节点，新的没有</span><br>    el.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;&quot;</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 新的有子节点，老的没有</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) &#123;<br>      <span class="hljs-keyword">let</span> child = newChildren[i];<br>      el.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElm</span>(child));<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-comment">// 比较两个虚拟节点是否一致</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isSameVnode</span>(<span class="hljs-params">oldVnode, newVnode</span>) &#123;<br>  <span class="hljs-keyword">return</span> (oldVnode.<span class="hljs-property">tag</span> === newVnode.<span class="hljs-property">tag</span> &amp;&amp;<br>    oldVnode.<span class="hljs-property">key</span> === newVnode.<span class="hljs-property">key</span> &amp;&amp;<br>    oldVnode.<span class="hljs-property">type</span> === newVnode.<span class="hljs-property">type</span>)<br>&#125;<br><span class="hljs-comment">// 比较子节点，更新子节点，需要用到双指针</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateChildren</span>(<span class="hljs-params">parent, oldChildren, newChildren</span>) &#123;<br>  <span class="hljs-comment">// 1.创建双指针</span><br>  <span class="hljs-keyword">let</span> oldStartIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 老的开始索引</span><br>  <span class="hljs-keyword">let</span> oldStartVnode = oldChildren[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 老的开始节点</span><br>  <span class="hljs-keyword">let</span> oldEndIndex = oldChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">// 老的结束索引</span><br>  <span class="hljs-keyword">let</span> oldEndVnode = oldChildren[oldEndIndex]; <span class="hljs-comment">// 老的结束节点</span><br><br>  <span class="hljs-keyword">let</span> newStartIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 新的开始索引</span><br>  <span class="hljs-keyword">let</span> newStartVnode = newChildren[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 新的开始节点</span><br>  <span class="hljs-keyword">let</span> newEndIndex = newChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">// 新的结束索引</span><br>  <span class="hljs-keyword">let</span> newEndVnode = newChildren[newEndIndex]; <span class="hljs-comment">// 新的结束节点</span><br><br>  <span class="hljs-comment">// 2.创建Ovnode映射表</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">makeIndexByKey</span>(<span class="hljs-params">children</span>) &#123;<br>    <span class="hljs-keyword">let</span> map = &#123;&#125;;<br>    children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child, index</span>) =&gt;</span> &#123;<br>      map[child.<span class="hljs-property">key</span>] = index;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> map;<br>  &#125;<br>  <span class="hljs-keyword">let</span> map = <span class="hljs-title function_">makeIndexByKey</span>(oldChildren);<br><br>  <span class="hljs-comment">// 3.循环比较</span><br>  <span class="hljs-keyword">while</span> (oldStartIndex &lt;= oldEndIndex &amp;&amp; newStartIndex &lt;= newEndIndex) &#123;<br>    <span class="hljs-comment">// 1.新的开始节点和老的开始节点比较</span><br>    <span class="hljs-keyword">if</span> (!oldStartVnode) &#123;<br>      <span class="hljs-comment">// 老的开始节点不存在，说明已经被移动走了</span><br>      oldStartVnode = oldChildren[++oldStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!oldEndVnode) &#123;<br>      <span class="hljs-comment">// 老的结束节点不存在，说明已经被移动走了</span><br>      oldEndVnode = oldChildren[--oldEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldStartVnode, newStartVnode)) &#123;<br>      <span class="hljs-comment">// 新的开始节点和老的开始节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldStartVnode, newStartVnode);<br>      <span class="hljs-comment">// 移动指针</span><br>      oldStartVnode = oldChildren[++oldStartIndex];<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldEndVnode, newEndVnode)) &#123;<br>      <span class="hljs-comment">// 新的结束节点和老的结束节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldEndVnode, newEndVnode);<br>      oldEndVnode = oldChildren[--oldEndIndex];<br>      newEndVnode = newChildren[--newEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldStartVnode, newEndVnode)) &#123;<br>      <span class="hljs-comment">// 新的结束节点和老的开始节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldStartVnode, newEndVnode);<br>      <span class="hljs-comment">// 将老的开始节点移动到老的结束节点的后面</span><br>      parent.<span class="hljs-title function_">insertBefore</span>(oldStartVnode.<span class="hljs-property">el</span>, oldEndVnode.<span class="hljs-property">el</span>.<span class="hljs-property">nextSibling</span>);<br>      oldStartVnode = oldChildren[++oldStartIndex];<br>      newEndVnode = newChildren[--newEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldEndVnode, newStartVnode)) &#123;<br>      <span class="hljs-comment">// 新的开始节点和老的结束节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldEndVnode, newStartVnode);<br>      <span class="hljs-comment">// 将老的结束节点移动到老的开始节点的前面</span><br>      parent.<span class="hljs-title function_">insertBefore</span>(oldEndVnode.<span class="hljs-property">el</span>, oldStartVnode.<span class="hljs-property">el</span>);<br>      oldEndVnode = oldChildren[--oldEndIndex];<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 以上四种情况都不满足，需要遍历查找</span><br>      <span class="hljs-comment">// 1.拿到老节点的key和索引的映射表</span><br>      <span class="hljs-keyword">let</span> moveIndex = map[newStartVnode.<span class="hljs-property">key</span>];<br>      <span class="hljs-keyword">if</span> (moveIndex === <span class="hljs-literal">undefined</span>) &#123;<br>        <span class="hljs-comment">// 说明新的开始节点在老的节点中不存在，直接插入到老的开始节点的前面</span><br>        parent.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-title function_">createElm</span>(newStartVnode), oldStartVnode.<span class="hljs-property">el</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 说明新的开始节点在老的节点中存在，直接移动到老的开始节点的前面</span><br>        <span class="hljs-keyword">let</span> moveVnode = oldChildren[moveIndex];<br>        oldChildren[moveIndex] = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 将移动的节点置为undefined</span><br>        parent.<span class="hljs-title function_">insertBefore</span>(moveVnode.<span class="hljs-property">el</span>, oldStartVnode.<span class="hljs-property">el</span>);<br>        <span class="hljs-title function_">patchVnode</span>(moveVnode, newStartVnode); <span class="hljs-comment">// 比较属性和子节点</span><br>      &#125;<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 4.循环结束后，老的还有剩余，新的没有，说明需要删除老的节点</span><br>  <span class="hljs-keyword">if</span> (oldStartIndex &lt;= oldEndIndex) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldStartIndex; i &lt;= oldEndIndex; i++) &#123;<br>      <span class="hljs-keyword">let</span> child = oldChildren[i];<br>      <span class="hljs-keyword">if</span> (child) &#123;<br>        parent.<span class="hljs-title function_">removeChild</span>(child.<span class="hljs-property">el</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 5.循环结束后，新的还有剩余，老的没有，说明需要新增新的节点</span><br>  <span class="hljs-keyword">if</span> (newStartIndex &lt;= newEndIndex) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newStartIndex; i &lt;= newEndIndex; i++) &#123;<br>      <span class="hljs-comment">// parent.appendChild(createElm(newChildren[i]));</span><br>      <span class="hljs-comment">// 将新的节点插入到老的结束节点的后面</span><br>      <span class="hljs-keyword">let</span> ele =<br>        newChildren[newEndIndex + <span class="hljs-number">1</span>] == <span class="hljs-literal">null</span><br>          ? <span class="hljs-literal">null</span><br>          : newChildren[newEndIndex + <span class="hljs-number">1</span>].<span class="hljs-property">el</span>;<br>      parent.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-title function_">createElm</span>(newChildren[i]), ele);<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-comment">// 更新属性</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateProperties</span>(<span class="hljs-params">vnode, oldProps = &#123;&#125;</span>) &#123;<br>  <span class="hljs-keyword">let</span> newProps = vnode.<span class="hljs-property">data</span> || &#123;&#125;;<br>  <span class="hljs-keyword">let</span> el = vnode.<span class="hljs-property">el</span>;<br>  <span class="hljs-comment">// 1.遍历老的属性</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> oldProps) &#123;<br>    <span class="hljs-comment">// 如果老的不存在新的属性，删除</span><br>    <span class="hljs-keyword">if</span> (!newProps[key]) &#123;<br>      el.<span class="hljs-title function_">removeAttribute</span>(key);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 2.样式处理</span><br>  <span class="hljs-keyword">let</span> newStyle = newProps.<span class="hljs-property">style</span> || &#123;&#125;;<br>  <span class="hljs-keyword">let</span> oldStyle = oldProps.<span class="hljs-property">style</span> || &#123;&#125;;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> oldStyle) &#123;<br>    <span class="hljs-comment">// 如果老的不存在新的样式，删除</span><br>    <span class="hljs-keyword">if</span> (!newStyle[key]) &#123;<br>      <span class="hljs-comment">// js中删除样式，直接设置为空或者null即可,注意undefined不管用</span><br>      el.<span class="hljs-property">style</span>[key] = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 3.遍历新的属性</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> newProps) &#123;<br>    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&quot;style&quot;</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> styleName <span class="hljs-keyword">in</span> newProps[key]) &#123;<br>        el.<span class="hljs-property">style</span>[styleName] = newProps[key][styleName];<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&quot;class&quot;</span>) &#123;<br>      el.<span class="hljs-property">className</span> = newProps[key];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      el.<span class="hljs-title function_">setAttribute</span>(key, newProps[key]);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElm</span>(<span class="hljs-params">vnode</span>) &#123;<br>  <span class="hljs-keyword">let</span> &#123; tag, children, key, data, text &#125; = vnode;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    <span class="hljs-comment">// 元素</span><br>    vnode.<span class="hljs-property">el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(tag); <span class="hljs-comment">// 创建元素</span><br>    <span class="hljs-title function_">updateProperties</span>(vnode); <span class="hljs-comment">// 更新属性</span><br>    children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> &#123;<br>      vnode.<span class="hljs-property">el</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElm</span>(child)); <span class="hljs-comment">// 递归渲染子节点</span><br>    &#125;);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 文本</span><br>    vnode.<span class="hljs-property">el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(text);<br>  &#125;<br>  <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">el</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面那么长的代码，我们来分步剖析。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/diff.jpg" width="50%"></p><p>vue仅在同级的vnode间做diff，递归地进行同级vnode的diff，最终实现整个DOM树的更新。因为在前端中，很少会跨越层级移动dom。</p><h4 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">tag</span> !== vnode.<span class="hljs-property">tag</span>) &#123;<br> <span class="hljs-keyword">return</span> oldVnode.<span class="hljs-property">el</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">replaceChild</span>(<span class="hljs-title function_">createElm</span>(vnode), oldVnode.<span class="hljs-property">el</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>先比较tag是否一致，不一致就<code>不会再去比较子节点</code>了，直接将旧节点替换成新节点(<code>createElm(vnode)</code>)</p><h4 id="文本"><a href="#文本" class="headerlink" title="文本"></a>文本</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 此时tag===undefined</span><br><span class="hljs-keyword">if</span> (!oldVnode.<span class="hljs-property">tag</span>) &#123;<br>  <span class="hljs-comment">// 文本</span><br>  <span class="hljs-keyword">if</span> (oldVnode.<span class="hljs-property">text</span> !== vnode.<span class="hljs-property">text</span>) &#123;<br>    <span class="hljs-keyword">return</span> (oldVnode.<span class="hljs-property">el</span>.<span class="hljs-property">textContent</span> = vnode.<span class="hljs-property">text</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后没有tag，肯定是文本，判断文本是否一致，<code>不一致再进行更新</code>（<code>直接将旧节点的textContent赋值为vdom的text</code>）</p><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> el = (vnode.<span class="hljs-property">el</span> = oldVnode.<span class="hljs-property">el</span>); <span class="hljs-comment">// 标签一样，直接复制老的节点,不用重新创建了</span><br><span class="hljs-title function_">updateProperties</span>(vnode, oldVnode.<span class="hljs-property">data</span>); <span class="hljs-comment">// 更新属性</span><br></code></pre></td></tr></table></figure><p>如果标签一致且不是文本，就比较属性。因为标签一致，所以直接复制（<code>vnode.el = oldVnode.el</code>）老的节点,不用重新创建了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 更新属性</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateProperties</span>(<span class="hljs-params">vnode, oldProps = &#123;&#125;</span>) &#123;<br>  <span class="hljs-keyword">let</span> newProps = vnode.<span class="hljs-property">data</span> || &#123;&#125;;<br>  <span class="hljs-keyword">let</span> el = vnode.<span class="hljs-property">el</span>;<br>  <span class="hljs-comment">// 1.遍历老的属性</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> oldProps) &#123;<br>    <span class="hljs-comment">// 如果老的不存在新的属性，删除</span><br>    <span class="hljs-keyword">if</span> (!newProps[key]) &#123;<br>      el.<span class="hljs-title function_">removeAttribute</span>(key);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 2.样式处理</span><br>  <span class="hljs-keyword">let</span> newStyle = newProps.<span class="hljs-property">style</span> || &#123;&#125;;<br>  <span class="hljs-keyword">let</span> oldStyle = oldProps.<span class="hljs-property">style</span> || &#123;&#125;;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> oldStyle) &#123;<br>    <span class="hljs-comment">// 如果老的不存在新的样式，删除</span><br>    <span class="hljs-keyword">if</span> (!newStyle[key]) &#123;<br>      <span class="hljs-comment">// js中删除样式，直接设置为空或者null即可,注意undefined不管用</span><br>      el.<span class="hljs-property">style</span>[key] = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 3.遍历新的属性</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> newProps) &#123;<br>    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&quot;style&quot;</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> styleName <span class="hljs-keyword">in</span> newProps[key]) &#123;<br>        el.<span class="hljs-property">style</span>[styleName] = newProps[key][styleName];<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-string">&quot;class&quot;</span>) &#123;<br>      el.<span class="hljs-property">className</span> = newProps[key];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      el.<span class="hljs-title function_">setAttribute</span>(key, newProps[key]);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>更新原则就是：</p><ul><li>遍历老的属性，新的不存在就删除</li><li>遍历新的属性，老的不存在就增加</li><li>style也要按上述原则进行遍历</li><li>class直接覆盖<h4 id="子节点children-1"><a href="#子节点children-1" class="headerlink" title="子节点children-1"></a>子节点children-1</h4></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 4.比较子节点</span><br>  <span class="hljs-keyword">let</span> oldChildren = oldVnode.<span class="hljs-property">children</span> || [];<br>  <span class="hljs-keyword">let</span> newChildren = vnode.<span class="hljs-property">children</span> || [];<br><br>  <span class="hljs-keyword">if</span> (oldChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; newChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 老的有子节点，新的也有子节点</span><br>    <span class="hljs-title function_">updateChildren</span>(el, oldChildren, newChildren);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 老的有子节点，新的没有</span><br>    el.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;&quot;</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newChildren.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 新的有子节点，老的没有</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) &#123;<br>      <span class="hljs-keyword">let</span> child = newChildren[i];<br>      el.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElm</span>(child));<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>最后比较children,比较原则就是：</p><ul><li>老的有子节点，新的也有子节点，执行updateChildren对比（核心，比较复杂，下面单独讲）</li><li>老的有子节点，新的没有，老的直接清空(<code>el.innerHTML = &quot;&quot;</code>)</li><li>新的子节点，老的没有，遍历新的进行新增</li></ul><h4 id="子节点children-2-updateChildren"><a href="#子节点children-2-updateChildren" class="headerlink" title="子节点children-2(updateChildren)"></a>子节点children-2(updateChildren)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 比较两个虚拟节点是否一致</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isSameVnode</span>(<span class="hljs-params">oldVnode, newVnode</span>) &#123;<br>  <span class="hljs-keyword">return</span> oldVnode.<span class="hljs-property">tag</span> === newVnode.<span class="hljs-property">tag</span> &amp;&amp; oldVnode.<span class="hljs-property">key</span> === newVnode.<span class="hljs-property">key</span> &amp;&amp; oldVnode.<span class="hljs-property">type</span> === newVnode.<span class="hljs-property">type</span>;<br>&#125;<br><span class="hljs-comment">// 比较子节点，更新子节点，需要用到双指针</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateChildren</span>(<span class="hljs-params">parent, oldChildren, newChildren</span>) &#123;<br>  <span class="hljs-comment">// 1.创建双指针</span><br>  <span class="hljs-keyword">let</span> oldStartIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 老的开始索引</span><br>  <span class="hljs-keyword">let</span> oldStartVnode = oldChildren[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 老的开始节点</span><br>  <span class="hljs-keyword">let</span> oldEndIndex = oldChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">// 老的结束索引</span><br>  <span class="hljs-keyword">let</span> oldEndVnode = oldChildren[oldEndIndex]; <span class="hljs-comment">// 老的结束节点</span><br><br>  <span class="hljs-keyword">let</span> newStartIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 新的开始索引</span><br>  <span class="hljs-keyword">let</span> newStartVnode = newChildren[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 新的开始节点</span><br>  <span class="hljs-keyword">let</span> newEndIndex = newChildren.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; <span class="hljs-comment">// 新的结束索引</span><br>  <span class="hljs-keyword">let</span> newEndVnode = newChildren[newEndIndex]; <span class="hljs-comment">// 新的结束节点</span><br><br>  <span class="hljs-comment">// 2.创建Ovnode映射表</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">makeIndexByKey</span>(<span class="hljs-params">children</span>) &#123;<br>    <span class="hljs-keyword">let</span> map = &#123;&#125;;<br>    children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child, index</span>) =&gt;</span> &#123;<br>      map[child.<span class="hljs-property">key</span>] = index;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> map;<br>  &#125;<br>  <span class="hljs-keyword">let</span> map = <span class="hljs-title function_">makeIndexByKey</span>(oldChildren);<br><br>  <span class="hljs-comment">// 3.循环比较</span><br>  <span class="hljs-keyword">while</span> (oldStartIndex &lt;= oldEndIndex &amp;&amp; newStartIndex &lt;= newEndIndex) &#123;<br>    <span class="hljs-comment">// 1.新的开始节点和老的开始节点比较</span><br>    <span class="hljs-keyword">if</span> (!oldStartVnode) &#123;<br>      <span class="hljs-comment">// 老的开始节点不存在，说明已经被移动走了</span><br>      oldStartVnode = oldChildren[++oldStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!oldEndVnode) &#123;<br>      <span class="hljs-comment">// 老的结束节点不存在，说明已经被移动走了</span><br>      oldEndVnode = oldChildren[--oldEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldStartVnode, newStartVnode)) &#123;<br>      <span class="hljs-comment">// 新的开始节点和老的开始节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldStartVnode, newStartVnode);<br>      <span class="hljs-comment">// 移动指针</span><br>      oldStartVnode = oldChildren[++oldStartIndex];<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldEndVnode, newEndVnode)) &#123;<br>      <span class="hljs-comment">// 新的结束节点和老的结束节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldEndVnode, newEndVnode);<br>      oldEndVnode = oldChildren[--oldEndIndex];<br>      newEndVnode = newChildren[--newEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldStartVnode, newEndVnode)) &#123;<br>      <span class="hljs-comment">// 新的结束节点和老的开始节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldStartVnode, newEndVnode);<br>      <span class="hljs-comment">// 将老的开始节点移动到老的结束节点的后面</span><br>      parent.<span class="hljs-title function_">insertBefore</span>(oldStartVnode.<span class="hljs-property">el</span>, oldEndVnode.<span class="hljs-property">el</span>.<span class="hljs-property">nextSibling</span>);<br>      oldStartVnode = oldChildren[++oldStartIndex];<br>      newEndVnode = newChildren[--newEndIndex];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSameVnode</span>(oldEndVnode, newStartVnode)) &#123;<br>      <span class="hljs-comment">// 新的开始节点和老的结束节点一样，直接比较属性和子节点</span><br>      <span class="hljs-title function_">patchVnode</span>(oldEndVnode, newStartVnode);<br>      <span class="hljs-comment">// 将老的结束节点移动到老的开始节点的前面</span><br>      parent.<span class="hljs-title function_">insertBefore</span>(oldEndVnode.<span class="hljs-property">el</span>, oldStartVnode.<span class="hljs-property">el</span>);<br>      oldEndVnode = oldChildren[--oldEndIndex];<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 以上四种情况都不满足，需要暴力比对遍历查找</span><br>      <span class="hljs-comment">// 1.拿到老节点的key和索引的映射表</span><br>      <span class="hljs-keyword">let</span> moveIndex = map[newStartVnode.<span class="hljs-property">key</span>];<br>      <span class="hljs-keyword">if</span> (moveIndex === <span class="hljs-literal">undefined</span>) &#123;<br>        <span class="hljs-comment">// 说明新的开始节点在老的节点中不存在，直接插入到老的开始节点的前面</span><br>        parent.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-title function_">createElm</span>(newStartVnode), oldStartVnode.<span class="hljs-property">el</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 说明新的开始节点在老的节点中存在，直接移动到老的开始节点的前面</span><br>        <span class="hljs-keyword">let</span> moveVnode = oldChildren[moveIndex];<br>        oldChildren[moveIndex] = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 将移动的节点置为undefined</span><br>        parent.<span class="hljs-title function_">insertBefore</span>(moveVnode.<span class="hljs-property">el</span>, oldStartVnode.<span class="hljs-property">el</span>);<br>        <span class="hljs-title function_">patchVnode</span>(moveVnode, newStartVnode); <span class="hljs-comment">// 比较属性和子节点</span><br>      &#125;<br>      newStartVnode = newChildren[++newStartIndex];<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 4.循环结束后，老的还有剩余，新的没有，说明需要删除老的节点</span><br>  <span class="hljs-keyword">if</span> (oldStartIndex &lt;= oldEndIndex) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldStartIndex; i &lt;= oldEndIndex; i++) &#123;<br>      <span class="hljs-keyword">let</span> child = oldChildren[i];<br>      <span class="hljs-keyword">if</span> (child) &#123;<br>        parent.<span class="hljs-title function_">removeChild</span>(child.<span class="hljs-property">el</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 5.循环结束后，新的还有剩余，老的没有，说明需要新增新的节点</span><br>  <span class="hljs-keyword">if</span> (newStartIndex &lt;= newEndIndex) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newStartIndex; i &lt;= newEndIndex; i++) &#123;<br>      <span class="hljs-comment">// parent.appendChild(createElm(newChildren[i]));</span><br>      <span class="hljs-comment">// 将新的节点插入到老的结束节点的后面</span><br>      <span class="hljs-keyword">let</span> ele =<br>        newChildren[newEndIndex + <span class="hljs-number">1</span>] == <span class="hljs-literal">null</span><br>          ? <span class="hljs-literal">null</span><br>          : newChildren[newEndIndex + <span class="hljs-number">1</span>].<span class="hljs-property">el</span>;<br>      parent.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-title function_">createElm</span>(newChildren[i]), ele);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在讲解之前，先学习下上面代码中的<code>isSameVnode</code></p><h6 id="isSameVnode"><a href="#isSameVnode" class="headerlink" title="isSameVnode"></a>isSameVnode</h6><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 比较两个虚拟节点是否一致</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isSameVnode</span>(<span class="hljs-params">oldVnode, newVnode</span>) &#123;<br>  <span class="hljs-keyword">return</span> oldVnode.<span class="hljs-property">tag</span> === newVnode.<span class="hljs-property">tag</span> &amp;&amp; oldVnode.<span class="hljs-property">key</span> === newVnode.<span class="hljs-property">key</span> &amp;&amp; oldVnode.<span class="hljs-property">type</span> === newVnode.<span class="hljs-property">type</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>此方法用来比较两个虚拟节点是否一致。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 不一致，tag不一样 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <br><span class="hljs-comment">&lt;!-- 一致，tag一样、key都为undefined,undefined===undefined --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <br><span class="hljs-comment">&lt;!-- 不一致，tag一样、key不一样 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;1&quot;</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 不一致，tag一样、key一样、但type不一样 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span> <br><span class="hljs-comment">&lt;!-- 一致，tag一样、key一样、type一样 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><h6 id="insertBefore语法"><a href="#insertBefore语法" class="headerlink" title="insertBefore语法"></a>insertBefore语法</h6><p>详见<a target="_blank" rel="noopener" href="https://www.w3school.com.cn/jsref/met_node_insertbefore.asp">w3c文档-insertBefore</a></p><p><code>Node.inserBefore(a,b)</code></p><ul><li>表示在Node的子节点b前面，如果a节点是通过<code>document.createElement</code>新创建的，此时表示<strong>插入</strong>a节点到b节点前面。</li><li>如果a节点不是新创建的，本来就是Node的子节点，此时表示<strong>移动</strong>a节点到b节点前面。</li><li>如果b为null，表示a插入/移动到末尾。</li></ul><h5 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h5><p>上面<code>updateChildren</code>方法比较复杂，我们来举个例子配合在网上找的图进行讲解：</p><p>假设我们现在的dom是 <code>a b c d e f</code>,所以对应的vdom也是<code>a b c d e f</code>，更新后的vdom是 <code>b f g</code>，此时我们要进行比对</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">a b c d e f<br>b f g<br></code></pre></td></tr></table></figure><h6 id="第1步"><a href="#第1步" class="headerlink" title="第1步"></a>第1步</h6><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/patch1-1.jpg" width="50%"><ul><li>该方法采用双指针模式进行新旧vdom比对，首先定义4个变量，Ovdom头尾双指针index以及指针对应的头尾vdom；定义4个变量，Nvdom头尾双指针index以及指针对应的头尾vdom</li><li>第一步：进行<code>isSameVnode</code>比对，即有<code>4种对比，头头(a与b)，尾尾(f与g)，头尾(a与g)，尾头(f与b)</code>,发现不相等，继续</li><li>第二步：将Ovode遍历，生成一个对象映射表（key:index）,<br>判断<code>newStartVnode.key</code>在映射表中有，说明在旧节点找到了，此时就开始操作真实dom了<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">let</span> moveVnode = oldChildren[moveIndex];<br>    oldChildren[moveIndex] = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 将vdom移动过的节点置为undefined</span><br>    parent.<span class="hljs-title function_">insertBefore</span>(moveVnode.<span class="hljs-property">el</span>, oldStartVnode.<span class="hljs-property">el</span>); <span class="hljs-comment">// 移动dom到Ovdom开始指针对应的节点前面</span><br>    <span class="hljs-title function_">patchVnode</span>(moveVnode, newStartVnode); <span class="hljs-comment">// 比较属性和子节点</span><br>&#125;<br> newStartVnode = newChildren[++newStartIndex]; <span class="hljs-comment">// Nvdom第一个节点已经结束，将Nvdom指针往后移动，然后重复循环前面步骤</span><br></code></pre></td></tr></table></figure>此时结果如下<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/patch1-2.jpg" width="50%"> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/patch1-3.jpg" width="50%"></li></ul><h6 id="第2步"><a href="#第2步" class="headerlink" title="第2步"></a>第2步</h6><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/patch2-1.jpg" width="50%"><h6 id="第3步"><a href="#第3步" class="headerlink" title="第3步"></a>第3步</h6><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/dom5.webp" width="50%"><h6 id="第4步"><a href="#第4步" class="headerlink" title="第4步"></a>第4步</h6><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/dom7.webp" width="50%"><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="通过映射表对比进行移动过后，Ovdom为什么要设置为undefined，而前4种对比进行移动不需要"><a href="#通过映射表对比进行移动过后，Ovdom为什么要设置为undefined，而前4种对比进行移动不需要" class="headerlink" title="通过映射表对比进行移动过后，Ovdom为什么要设置为undefined，而前4种对比进行移动不需要?"></a>通过映射表对比进行移动过后，Ovdom为什么要设置为undefined，而前4种对比进行移动不需要?</h3><p>因为对比主要依靠双指针进行移动收缩范围，<strong>映射表对比要设置为undefined</strong>，是因为此时OvdomIndex指针并没有移动，后面循环还会从这里开始，所以改为undefined,会判断不存在直接跳过。<br><strong>前四种不需要</strong>，是因为此时OvdomIndex指针会进行移动，范围就会收缩，后面循环只会在指针内进行，所以设不设置已经无意义，反正不会走进去了（<code>while(oldStartIndex &lt;= oldEndIndex &amp;&amp; newStartIndex &lt;= newEndIndex)</code>）。</p><h3 id="为什要加key"><a href="#为什要加key" class="headerlink" title="为什要加key?"></a>为什要加key?</h3><h4 id="key的作用"><a href="#key的作用" class="headerlink" title="key的作用"></a>key的作用</h4><p>经常上面的理解,我们可以知道vue更新时候,使用key，diff算法能更加准确和快捷(最小化元素移动的算法).如果不使用key,vue就会<strong>就地更新选择复用节点</strong>,可能会产生一些bug.<br>举个例子:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/vue/2.7.14/vue.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;a&quot;</span>&gt;</span>1:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-else</span>&gt;</span>2:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;a=false&quot;</span>&gt;</span>切换<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">el</span>: <span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="language-javascript">      <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">a</span>: <span class="hljs-literal">true</span>,</span><br><span class="language-javascript">        &#125;;</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">    &#125;);</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>我们在input上输入内容,切换按钮,发现input的内容并未清除.原因很简单,因为没有key, vue判断标签一样,所以自然不会更新.</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/key1.gif"><h4 id="使用index作为key产生的问题"><a href="#使用index作为key产生的问题" class="headerlink" title="使用index作为key产生的问题"></a>使用index作为key产生的问题</h4><p>从代码的规范性来讲：基本不会考虑用index 做为key；但在实际业务开发过程，也没法强制要求后端同事返回的列表元素携带唯一的id值。</p><ul><li>对于一些数据，仅用于渲染表展示的，使用index作为key一般是没有任何问题的</li><li>如果在列表中存在输入类的表单dom这种，可能就会产生错误DOM更新，界面也会有问题</li><li>有新增，删除，插入，排序等破坏顺序的情况，因为用的index作为key, index变化,导致key也变化, 最终会产生没有必要的对比,降低效率,甚至产生一些问题.</li><li>如果列表中是纯文本节点不会有问题,因为也会对比替换,只不过和上面第三点描述的一样, 产生了没有必要的对比.</li><li>在使用非文本节点的组件，只要你的组件在遍历渲染时候没有依赖于响应式的props，那么此时对于列表的删除操作会导致视图错乱,有依赖响应式的props，用key做index就不会有问题.</li><li>可不可以使用随机数作为key呢？答案自然是不能够。因为key值无论是删除还是反转，根本就不能找到相同的key，diff算法就毫无意义了，压根没有复用性可言。</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.bootcdn.net/ajax/libs/vue/2.7.14/vue.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item,index) in data&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;change&quot;</span>&gt;</span>change<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">el</span>: <span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="language-javascript">      <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">item</span>: &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;&#123;&#123;window.Math.random()&#125;&#125;&lt;/div&gt;`</span>,</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">      <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="language-javascript">        &#125;;</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">      <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//删除数据</span></span><br><span class="language-javascript">        <span class="hljs-title function_">change</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">          <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">    &#125;);</span><br><span class="language-javascript">  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>上面代码是删除的第一项,但发现每次都是最后一个被删掉.</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/key2.gif"><p>TODO: 后面学习到组件对比会讲解.</p><blockquote><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/225105999">https://zhuanlan.zhihu.com/p/225105999</a></p></blockquote></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mystylemylife.github.io/ypf-blog">ypf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mystylemylife.github.io/ypf-blog/2023/09/28/vue2%E6%BA%90%E7%A0%81/9.diff%E7%AE%97%E6%B3%95(patch)/">https://mystylemylife.github.io/ypf-blog/2023/09/28/vue2%E6%BA%90%E7%A0%81/9.diff%E7%AE%97%E6%B3%95(patch)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mystylemylife.github.io/ypf-blog" target="_blank">ypf的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/ypf-blog/2023/11/02/vue2%E6%BA%90%E7%A0%81/10.computed/" title="10.computed"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">10.computed</div></div></a></div><div class="next-post pull-right"><a href="/ypf-blog/2023/08/04/vue2%E6%BA%90%E7%A0%81/8.watch/" title="8.watch"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">8.watch</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BD%95%E6%93%8D%E4%BD%9Cdom%E6%80%A7%E8%83%BD%E5%B7%AE%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">为何操作dom性能差？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="toc-number">1.1.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="toc-number">1.2.</span> <span class="toc-text">案例二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#patch%E6%AF%94%E5%AF%B9"><span class="toc-number">2.</span> <span class="toc-text">patch比对</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%BF%86"><span class="toc-number">2.1.</span> <span class="toc-text">回忆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">2.2.</span> <span class="toc-text">第一次渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%BF%9B%E8%A1%8Cpatch%E5%AF%B9%E6%AF%94"><span class="toc-number">2.3.</span> <span class="toc-text">更新进行patch对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-number">2.3.1.</span> <span class="toc-text">标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%9C%AC"><span class="toc-number">2.3.2.</span> <span class="toc-text">文本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.3.</span> <span class="toc-text">属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9children-1"><span class="toc-number">2.3.4.</span> <span class="toc-text">子节点children-1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%90%E8%8A%82%E7%82%B9children-2-updateChildren"><span class="toc-number">2.3.5.</span> <span class="toc-text">子节点children-2(updateChildren)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#isSameVnode"><span class="toc-number">2.3.5.0.1.</span> <span class="toc-text">isSameVnode</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#insertBefore%E8%AF%AD%E6%B3%95"><span class="toc-number">2.3.5.0.2.</span> <span class="toc-text">insertBefore语法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#updateChildren"><span class="toc-number">2.3.5.1.</span> <span class="toc-text">updateChildren</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC1%E6%AD%A5"><span class="toc-number">2.3.5.1.1.</span> <span class="toc-text">第1步</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC2%E6%AD%A5"><span class="toc-number">2.3.5.1.2.</span> <span class="toc-text">第2步</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC3%E6%AD%A5"><span class="toc-number">2.3.5.1.3.</span> <span class="toc-text">第3步</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC4%E6%AD%A5"><span class="toc-number">2.3.5.1.4.</span> <span class="toc-text">第4步</span></a></li></ol></li></ol></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%98%A0%E5%B0%84%E8%A1%A8%E5%AF%B9%E6%AF%94%E8%BF%9B%E8%A1%8C%E7%A7%BB%E5%8A%A8%E8%BF%87%E5%90%8E%EF%BC%8COvdom%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%AE%BE%E7%BD%AE%E4%B8%BAundefined%EF%BC%8C%E8%80%8C%E5%89%8D4%E7%A7%8D%E5%AF%B9%E6%AF%94%E8%BF%9B%E8%A1%8C%E7%A7%BB%E5%8A%A8%E4%B8%8D%E9%9C%80%E8%A6%81"><span class="toc-number">3.1.</span> <span class="toc-text">通过映射表对比进行移动过后，Ovdom为什么要设置为undefined，而前4种对比进行移动不需要?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E8%A6%81%E5%8A%A0key"><span class="toc-number">3.2.</span> <span class="toc-text">为什要加key?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#key%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">key的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8index%E4%BD%9C%E4%B8%BAkey%E4%BA%A7%E7%94%9F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.2.</span> <span class="toc-text">使用index作为key产生的问题</span></a></li></ol></li></ol></li></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By ypf</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/js/code-collapse.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/search/local-search.min.js"></script></div></div></body></html>