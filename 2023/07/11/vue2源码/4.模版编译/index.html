<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>4.模版编译 | ypf的博客</title><meta name="author" content="ypf"><meta name="copyright" content="ypf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="我们前面讲了vue初始化的时候会进行数据劫持，下面我们开始讲vue的模版编译，在这之前我们先看下官网的生命周期 生命周期  vue2官网-生命周期 vue大致渲染流程vue初次渲染（ new vue() ）-&amp;gt;初始化数据(initState)-&amp;gt;模版编译-&amp;gt;将template变成r"><link rel="shortcut icon" href="/ypf-blog/img/favicon.png"><link rel="canonical" href="https://mystylemylife.github.io/ypf-blog/2023/07/11/vue2%E6%BA%90%E7%A0%81/4.%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.staticfile.net/font-awesome/6.7.1/css/all.min.css"><script>const GLOBAL_CONFIG = {
  root: '/ypf-blog/',
  algolia: undefined,
  localSearch: {"path":"/ypf-blog/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"4.模版编译",isPost:!0,isHome:!1,isHighlightShrink:void 0,isToc:!0,postUpdate:"2023-11-10 09:58:07"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/css/atom-one-dark.css"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAYAAAA5ZDbSAAAAAXNSR0IArs4c6QAABhdJREFUeF7tnW9MlmUUxg+ELHGtTEWCRmt+sD9SCYrYIGtJpmkuR0NMIh2mgIEaBEaJaAhCooOAbBQGtgHhWolbm9CXam0xy3IUNSotczkSRHOrJtBulnPo8/g+HN4X33O47i984Dn3fa7r957z3Hvu94/PrIXPDhCGWgd8AFgt20FhAKybLwAr5wvAAKzdAeX6cA8GYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoGYOUOKJeHCgZg5Q4ol4cKBmDlDiiXhwoG4OvngK+vL5VvzyR//3GWSXxx5Bi9U/+RRxNMevoJio58wHKNjs4TtGvvfo+uP9LJvbqC/cf50eH6CgoYf6OlzoGBAUrK2Erfdx4fqQ+W8dOn3UF1Zfnk4+Nj+f8j33bQupxCj6ztrkm9GrAROTcijMq2Z9rq7T7bSwtWpLvLjyHzfPxeGU2aeLPl3H//8y/FLk8j89ebh9cDNuaV5m2gmDkzbX1sPNhCJVV1bvU5c91Kin8y1nbODXml9HnbN25d0xOTiQDspFXHp+TSL7/+7haP7gwNoYaqAtvW3PpZG+XseMMta3l6EhGAjQlREWGDGy67cbqrmxYnbXSLX4fq9lDgpImWc507f4FiE9ZTf3+/W9by9CRiABsjXt+SQfOiwm092dfYTBX73h+RZ+mr4ykxbpHtpm7Vpm3U/sPPI1pjNINFAXbVqvv7B+ip5Cw69UcXy8PQkCBqeqvItjV74l7PSnQYQaIAD7bq8BlU/lqWrcTfTp2mZckvDcOCy5d+WLOLgqdOtox15y2AlRwzSBxgo7Pk1XR6eG6ErWTTpk27Hs5Ym7iMkhOWWoaYzhD3fDaZF4+0IRKwn98N1NpQafsApK+vj5Y89yJ1nelxxCM4aAp9UF1Cvr7WDzQq322imoaDjubytotEAnbSqjuPn6SE1FxHfh+oLqbQ4KmW1w5nHkeLjfJFYgEbn4pfSadHHrRv1ebhh9kYXWusil9CqUlxlpdcvNhHixIzqKf3/Chjcd9yogG7atUG0IIVL9C5vy5YOjb51lvoUO0e29acv7uamg9/6j63r8NMogEbvyJn3ksVBfa75i+/bqe03GJLa/eXbyNzoGA1vjrWQWuzvfsgwcnrRTxgI7Lo5fX0aPRsW71rsgroaPuPQ/6/eH405W1aYxkj5SBhzAA2rbqlvoImBIy31Hymp5cef+byiZM5fjTHkObBidWQcpAwZgAbobPvv4cqC7NtNb9Ze4De/v/NAaVbN1KMzSG+pIOEMQXYiC3cnEbzYyJtd8RmwxUSNIVqy/Itr5F2kDDmALtq1W1Hv6PbgwPptsCrH0ead4dIO0gYc4CN4Fn33U1VRTlOtA+5pqm5lXZW1g47ztsDVOyirzR5R04qxT40x7H3Ug8SnAhUCdi8G7OloYJumhDg0gPJBwkuxWn+5bPwsLto787NLj2QfJDgUpxmwEZ8QXYKPTYvytaHn06cpOUpzg4knJjpjdeobNGXjDat+pPGSssHIOZIceFK2QcJTl5QqgEbA2p2b6EZ06dd5cWf3WcHAWsfAKycMAADsGwH0KKV/8Q7AAOw7BblInvcg1XjJf2/AI4WjRatuobRolXjRYtWjheAAVi6A9hkYZMl/TV8zfyxyVKNF/dg5XgBGIClO2A+7WA+9XDlMN/jsXS1/bf2SNd9KX/192AtoLg6AJjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpoAzHVOSBwACwHFTROAuc4JiQNgIaC4aQIw1zkhcQAsBBQ3TQDmOickDoCFgOKmCcBc54TEAbAQUNw0AZjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpoAzHVOSBwACwHFTROAuc4JiQNgIaC4aQIw1zkhcQAsBBQ3TQDmOickDoCFgOKmCcBc54TEAbAQUNw0AZjrnJA4ABYCipsmAHOdExIHwEJAcdMEYK5zQuIAWAgobpr/AdetiMf12lDxAAAAAElFTkSuQmCC" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/ypf-blog/archives/"><div class="headline">文章</div><div class="length-num">81</div></a><a href="/ypf-blog/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/ypf-blog/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ypf-blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> gwy</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/ypf-blog/categories/gwy/LFTT/"><span>LFTT</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/ypf-blog/" title="ypf的博客"><span class="site-name">ypf的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ypf-blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> gwy</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/ypf-blog/categories/gwy/LFTT/"><span>LFTT</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">4.模版编译</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-11T06:44:29.961Z" title="发表于 2023-07-11 14:44:29">2023-07-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-10T01:58:07.799Z" title="更新于 2023-11-10 09:58:07">2023-11-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/ypf-blog/categories/vue2%E6%BA%90%E7%A0%81/">vue2源码</a></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><p>我们前面讲了vue初始化的时候会进行数据劫持，下面我们开始讲vue的模版编译，在这之前我们先看下官网的生命周期</p><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/lifecycle.png" width="50%"><p><a target="_blank" rel="noopener" href="https://v2.cn.vuejs.org/v2/guide/instance.html">vue2官网-生命周期</a></p><h3 id="vue大致渲染流程"><a href="#vue大致渲染流程" class="headerlink" title="vue大致渲染流程"></a>vue大致渲染流程</h3><p>vue初次渲染（ new vue() ）-&gt;初始化数据(initState)-&gt;<strong>模版编译</strong>-&gt;将template变成render-&gt;生成虚拟dom-&gt;变成真实dom-&gt;放到页面</p><h3 id="本节要讲的模版编译的流程"><a href="#本节要讲的模版编译的流程" class="headerlink" title="本节要讲的模版编译的流程"></a>本节要讲的模版编译的流程</h3><p>首先el必须要有<br>-&gt;有render直接生成虚拟dom<br>-&gt;没有render，判断option中有没有template选项，有的话将template-&gt;变成render-&gt;生成虚拟dom<br>-&gt; 没有template，直接将<code>el.outerHTML</code>作为模版-&gt;变成render-&gt;生成虚拟dom</p><p>所以优先级是：el节点必须要有-render-template-el.outerHTML</p><p><strong>注意：el.outerHTML()和el.innerHTML()的区别是， outerHTML包含本层，innerHTML只包含子节点</strong></p><h2 id="获取template"><a href="#获取template" class="headerlink" title="获取template"></a>获取template</h2><p>现在我们根据上面模版编译的流程，开始通过代码获取模版</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js">修改src/init.<span class="hljs-property">js</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>    vm.<span class="hljs-property">$options</span> = options;<br>    <span class="hljs-title function_">initState</span>(vm);<br>    <span class="hljs-comment">// 1. 从options中取出el进行挂载</span><br>    <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>) &#123;<br>      vm.$mount(vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>);<br>    &#125;<br>  &#125;;<br>  <span class="hljs-comment">// 2. 原型上定义$mount方法</span><br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) &#123;<br>    <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-keyword">const</span> options = vm.<span class="hljs-property">$options</span>;<br>    el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(el);<br>    <span class="hljs-comment">// 默认先会查找有没有render方法，没有render会采用template，template也没有就用el中的内容</span><br>    <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">render</span>) &#123;<br>      <span class="hljs-comment">// 对模版进行编译</span><br>      <span class="hljs-keyword">let</span> template = options.<span class="hljs-property">template</span>;<br>      <span class="hljs-keyword">if</span> (!template &amp;&amp; el) &#123;<br>        template = el.<span class="hljs-property">outerHTML</span>;<br>      &#125;<br>      <span class="hljs-comment">// 我们可以自己测试下，在option传template会用options的，没有用el.outerHTML()</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(template);<br>      <span class="hljs-comment">//  &lt;div id=&quot;app&quot;&gt;</span><br>      <span class="hljs-comment">//测试&#123;&#123;a&#125;&#125;</span><br>    <span class="hljs-comment">//&lt;/div&gt;</span><br>    &#125;<br>  &#125;;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>至此我们已经拿到了template，我们这里直接不传template，直接在body里面写,方便</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html">修改index.html<br>...<br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>      测试&#123;&#123;a&#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> aa = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">      <span class="hljs-attr">el</span>: <span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="language-javascript">      <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">          <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,</span><br><span class="language-javascript">        &#125;;</span><br><span class="language-javascript">      &#125;,</span><br><span class="language-javascript">      <span class="hljs-comment">// template: &quot;&lt;div&gt;测试1&#123;&#123;a&#125;&#125;&lt;/div&gt;&quot;,</span></span><br><span class="language-javascript">    &#125;);</span><br><span class="language-javascript">    ...</span><br></code></pre></td></tr></table></figure><p>运行如下：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/template-str.jpg" width="50%"><h2 id="template变成render"><a href="#template变成render" class="headerlink" title="template变成render"></a>template变成render</h2><p>大致流程如下：template-&gt;ast语法树-&gt;render字符串-&gt;render函数</p><h3 id="template变成ast"><a href="#template变成ast" class="headerlink" title="template变成ast"></a>template变成ast</h3><p>上面我们已经获取到template字符串了， 那么如何转换成ast?</p><h4 id="vue-template-compiler包"><a href="#vue-template-compiler包" class="headerlink" title="vue-template-compiler包"></a>vue-template-compiler包</h4><p>实际上，我们可以通过<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue/tree/main/packages/template-compiler">vue-template-compiler</a>快速把template转换成ast。随便找个文件夹测试下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> compiler = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;vue-template-compiler&#x27;</span>)<br><span class="hljs-keyword">const</span> ast=compiler.<span class="hljs-title function_">compile</span>(<span class="hljs-string">&#x27;&lt;div id=&quot;app&quot;&gt;test&#123;a&#125;&lt;/div&gt;&#x27;</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ast)<br></code></pre></td></tr></table></figure><p>运行结果如下：</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/compiler.jpg" width="50%"><h4 id="astexplorer"><a href="#astexplorer" class="headerlink" title="astexplorer"></a>astexplorer</h4><p>我们也可以访问<a target="_blank" rel="noopener" href="https://astexplorer.net/">astexplorer</a>快速查看对应的ast</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/ast.jpg" width="50%"><h4 id="自己编写"><a href="#自己编写" class="headerlink" title="自己编写"></a>自己编写</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-number">1.</span>修改src/init.<span class="hljs-property">js</span><br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) &#123;<br>      ...<br>      <span class="hljs-keyword">if</span> (!template &amp;&amp; el) &#123;<br>        template = el.<span class="hljs-property">outerHTML</span>;<br>      &#125;<br>      <span class="hljs-comment">// 1.增加编译模版方法</span><br>      <span class="hljs-title function_">compileToFunction</span>(template)<br>    &#125;<br>  &#125;;<br><span class="hljs-number">2.</span>新建src/compiler/index.<span class="hljs-property">js</span><br><span class="hljs-keyword">import</span> &#123; parseHTML &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./parseAst.js&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compileToFunction</span>(<span class="hljs-params">template</span>) &#123;<br>  <span class="hljs-comment">// 2.将模版转换成ast语法树</span><br>  <span class="hljs-keyword">let</span> ast = <span class="hljs-title function_">parseHTML</span>(template);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ast, <span class="hljs-string">&quot;ast&quot;</span>);<br>&#125;<br><span class="hljs-number">3.</span> 新建src/compiler/parseAst.<span class="hljs-property">js</span>，定义转换ast的方法<br><span class="hljs-comment">// Regular Expressions for parsing tags and attributes</span><br><span class="hljs-keyword">const</span> ncname = <span class="hljs-string">`[a-zA-Z_][\\-\\.0-9_a-zA-Z]*`</span>; <span class="hljs-comment">// 匹配标签名 div、p、span等等</span><br><span class="hljs-keyword">const</span> qnameCapture = <span class="hljs-string">`((?:<span class="hljs-subst">$&#123;ncname&#125;</span>\\:)?<span class="hljs-subst">$&#123;ncname&#125;</span>)`</span>; <span class="hljs-comment">// 匹配特殊标签名，比如：my:xx</span><br><span class="hljs-keyword">const</span> attribute =<br>  <span class="hljs-regexp">/^\s*([^\s&quot;&#x27;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&#x27;([^&#x27;]*)&#x27;+|([^\s&quot;&#x27;=&lt;&gt;`]+)))?/</span>; <span class="hljs-comment">// 匹配属性</span><br><span class="hljs-keyword">const</span> dynamicArgAttribute =<br>  <span class="hljs-regexp">/^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+?\][^\s&quot;&#x27;&lt;&gt;\/=]*)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&#x27;([^&#x27;]*)&#x27;+|([^\s&quot;&#x27;=&lt;&gt;`]+)))?/</span>; <span class="hljs-comment">// 匹配动态参数</span><br><span class="hljs-keyword">const</span> startTagOpen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`^&lt;<span class="hljs-subst">$&#123;qnameCapture&#125;</span>`</span>); <span class="hljs-comment">// 标签开头的正则，捕获的内容是标签名</span><br><span class="hljs-keyword">const</span> startTagClose = <span class="hljs-regexp">/^\s*(\/?)&gt;/</span>; <span class="hljs-comment">// 匹配标签结束的 &gt;</span><br><span class="hljs-keyword">const</span> endTag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`^&lt;\\/<span class="hljs-subst">$&#123;qnameCapture&#125;</span>[^&gt;]*&gt;`</span>); <span class="hljs-comment">// 匹配结尾标签 &lt;/div&gt;</span><br><span class="hljs-keyword">const</span> defaultTagRE = <span class="hljs-regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span>; <span class="hljs-comment">// 匹配双括号</span><br><span class="hljs-comment">// 构造ast语法树结构</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createASTElement</span>(<span class="hljs-params">tagName, attrs</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">tag</span>: tagName, <span class="hljs-comment">// 标签名</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 节点类型（js中的node.nodeType, 1 Element 2 Attribute 3 Text 4 CDATA Section 5 Entity Reference 6 Entity 7 Processing Instrucion 8 Comment 9 Document 10 Document Type 11 Document Fragment 12 Notation）</span><br>    <span class="hljs-attr">children</span>: [], <span class="hljs-comment">// 子节点</span><br>    attrs, <span class="hljs-comment">// 属性集合</span><br>    <span class="hljs-attr">parent</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 是否有父节点</span><br>  &#125;;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params">html</span>) &#123;<br>  <span class="hljs-comment">// &lt;div id=&quot;app&quot;&gt;测试&#123;&#123;a&#125;&#125;&lt;/div&gt;</span><br>  <span class="hljs-comment">// console.log(html);</span><br>  <span class="hljs-keyword">let</span> root = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 根节点</span><br>  <span class="hljs-keyword">let</span> stack = []; <span class="hljs-comment">// 栈结构（先进后出），开始标签一个个入栈，结束标签一个个出栈</span><br>  <span class="hljs-keyword">let</span> currentParent; <span class="hljs-comment">// 当前父节点</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">tagName, attrs</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tagName, attrs, <span class="hljs-string">&quot;开始标签&quot;</span>);<br>    <span class="hljs-keyword">let</span> element = <span class="hljs-title function_">createASTElement</span>(tagName, attrs);<br>    <span class="hljs-keyword">if</span> (!root) &#123;<br>      root = element;<br>    &#125;<br>    currentParent = element;<br>    stack.<span class="hljs-title function_">push</span>(element);<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">end</span>(<span class="hljs-params">tagName</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tagName, <span class="hljs-string">&quot;结束标签&quot;</span>);<br>    <span class="hljs-keyword">let</span> element = stack.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// 取出栈中最后一个，前一个就是当前的父节点</span><br>    currentParent = stack[stack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]; <span class="hljs-comment">// 当前父节点</span><br>    <span class="hljs-keyword">if</span> (currentParent) &#123;<br>      <span class="hljs-comment">// 在闭合时可以知道这个标签的父亲是谁</span><br>      element.<span class="hljs-property">parent</span> = currentParent;<br>      currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(element); <span class="hljs-comment">// 实现一个树的父子关系</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">chars</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text, <span class="hljs-string">&quot;文本&quot;</span>);<br>    text = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s/g</span>, <span class="hljs-string">&quot;&quot;</span>); <span class="hljs-comment">// 去除空格</span><br>    <span class="hljs-keyword">if</span> (text) &#123;<br>      currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(&#123;<br>        <span class="hljs-comment">// 文本没有标签，直接放到父节点的children中</span><br>        <span class="hljs-attr">type</span>: <span class="hljs-number">3</span>,<br>        text,<br>      &#125;);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// html为空结束循环</span><br>  <span class="hljs-keyword">while</span> (html) &#123;<br>    <span class="hljs-keyword">let</span> textEnd = html.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;&lt;&quot;</span>); <span class="hljs-comment">// 查找&lt;的索引</span><br>    <span class="hljs-comment">// 如果当前索引为0，肯定是一个标签，开始标签&lt;或结束标签&lt;/中的 &lt;</span><br>    <span class="hljs-keyword">if</span> (textEnd == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// (1）开始标签</span><br>      <span class="hljs-keyword">let</span> startTagMatch = <span class="hljs-title function_">parseStartTag</span>(); <span class="hljs-comment">// 将开始标签转换成对应的ast语法树</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(startTagMatch, <span class="hljs-string">&quot;startTagMatch&quot;</span>);<br>      <span class="hljs-comment">//    &#123;</span><br>      <span class="hljs-comment">//     &quot;tagName&quot;: &quot;div&quot;,</span><br>      <span class="hljs-comment">//     &quot;attrs&quot;: [</span><br>      <span class="hljs-comment">//         &#123;</span><br>      <span class="hljs-comment">//             &quot;name&quot;: &quot;id&quot;,</span><br>      <span class="hljs-comment">//             &quot;value&quot;: &quot;app&quot;</span><br>      <span class="hljs-comment">//             &#125;</span><br>      <span class="hljs-comment">//         ]</span><br>      <span class="hljs-comment">//    &#125;</span><br>      <span class="hljs-keyword">if</span> (startTagMatch) &#123;<br>        <span class="hljs-title function_">start</span>(startTagMatch.<span class="hljs-property">tagName</span>, startTagMatch.<span class="hljs-property">attrs</span>); <span class="hljs-comment">// 解析开始标签</span><br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      <span class="hljs-comment">// (2）结束标签</span><br>      <span class="hljs-keyword">let</span> endTagMatch = html.<span class="hljs-title function_">match</span>(endTag);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(endTagMatch, <span class="hljs-string">&quot;endTagMatch&quot;</span>); <span class="hljs-comment">// [&#x27;&lt;/div&gt;&#x27;, &#x27;div&#x27;, index: 0, input: &#x27;&lt;/div&gt;&#x27;, groups: undefined]</span><br>      <span class="hljs-keyword">if</span> (endTagMatch) &#123;<br>        <span class="hljs-title function_">advance</span>(endTagMatch[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>); <span class="hljs-comment">// 删除结束标签</span><br>        <span class="hljs-title function_">end</span>(endTagMatch[<span class="hljs-number">1</span>]); <span class="hljs-comment">//  处理结束标签</span><br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// 如果索引大于0，肯定是文本</span><br>    <span class="hljs-keyword">let</span> text;<br>    <span class="hljs-keyword">if</span> (textEnd &gt; <span class="hljs-number">0</span>) &#123;<br>      text = html.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, textEnd); <span class="hljs-comment">// 获取文本</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (text) &#123;<br>      <span class="hljs-title function_">advance</span>(text.<span class="hljs-property">length</span>); <span class="hljs-comment">// 删除文本</span><br>      <span class="hljs-title function_">chars</span>(text); <span class="hljs-comment">// 处理文本</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 将开始标签转换成对应的ast语法树 &#123;&quot;tagName&quot;: &quot;div&quot;,&quot;attrs&quot;: [&#123;&quot;name&quot;: &quot;id&quot;,&quot;value&quot;: &quot;app&quot;&#125;]&#125;</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseStartTag</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> start = html.<span class="hljs-title function_">match</span>(startTagOpen); <span class="hljs-comment">// 匹配开始标签 结果：[&quot;&lt;div&quot;,&quot;div&quot;,groups: undefined,index:0,input:&quot;&lt;div id=\&quot;app\&quot;&gt;测试&#123;&#123;a&#125;&#125;&lt;/div&gt;&quot;,length:2] 或者false</span><br>    <span class="hljs-keyword">if</span> (start) &#123;<br>      <span class="hljs-keyword">const</span> match = &#123;<br>        <span class="hljs-attr">tagName</span>: start[<span class="hljs-number">1</span>], <span class="hljs-comment">// 标签名</span><br>        <span class="hljs-attr">attrs</span>: [], <span class="hljs-comment">// 属性</span><br>      &#125;;<br>      <span class="hljs-title function_">advance</span>(start[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>); <span class="hljs-comment">// 删除开始标签</span><br>      <span class="hljs-comment">//  匹配属性（注意：多个属性、&gt;结束）</span><br>      <span class="hljs-keyword">let</span> end, attr;<br>      <span class="hljs-comment">// 如果没有遇到标签结尾就不停的解析</span><br>      <span class="hljs-comment">// console.log(html.match(startTagClose),1); // 匹配到了&gt; 结果：[&quot;&gt;&quot;,groups: undefined,index: 0,input: &quot;&lt;div id=\&quot;app\&quot;&gt;测试&#123;&#123;a&#125;&#125;&lt;/div&gt;&quot;,length: 1]</span><br>      <span class="hljs-comment">// console.log(html.match(attribute),2); // 匹配到了属性 结果：[&quot;id=\&quot;app\&quot;&quot;,&quot;id&quot;,&quot;=&quot;,&quot;app&quot;,undefined,undefined,index: 0,input: &quot;&lt;div id=\&quot;app\&quot;&gt;测试&#123;&#123;a&#125;&#125;&lt;/div&gt;&quot;,length: 2]</span><br>      <span class="hljs-keyword">while</span> (<br>        <span class="hljs-comment">// 没有遇到标签结尾</span><br>        !(end = html.<span class="hljs-title function_">match</span>(startTagClose)) &amp;&amp;<br>        <span class="hljs-comment">// 匹配到了动态参数属性或者匹配到了普通属性</span><br>        (attr = html.<span class="hljs-title function_">match</span>(dynamicArgAttribute) || html.<span class="hljs-title function_">match</span>(attribute))<br>      ) &#123;<br>        match.<span class="hljs-property">attrs</span>.<span class="hljs-title function_">push</span>(&#123;<br>          <span class="hljs-attr">name</span>: attr[<span class="hljs-number">1</span>],<br>          <span class="hljs-attr">value</span>: attr[<span class="hljs-number">3</span>] || attr[<span class="hljs-number">4</span>] || attr[<span class="hljs-number">5</span>],<br>        &#125;); <span class="hljs-comment">// 将属性放到match.attrs中</span><br>        <span class="hljs-title function_">advance</span>(attr[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>); <span class="hljs-comment">//  删除属性</span><br>        attr.<span class="hljs-property">start</span> = html.<span class="hljs-property">length</span>; <span class="hljs-comment">// 属性开始的索引</span><br>        attr.<span class="hljs-property">end</span> = html.<span class="hljs-property">length</span>; <span class="hljs-comment">// 属性结束的索引</span><br>      &#125;<br>      <span class="hljs-keyword">if</span> (end) &#123;<br>        <span class="hljs-title function_">advance</span>(end[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>); <span class="hljs-comment">// 删除开始标签</span><br>        <span class="hljs-keyword">return</span> match;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 删除匹配到的内容</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">advance</span>(<span class="hljs-params">n</span>) &#123;<br>    html = html.<span class="hljs-title function_">substring</span>(n); <span class="hljs-comment">// 删除n个字符</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(html, <span class="hljs-string">&quot;html&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> root;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>上面的代码在index.html用如下模版测试下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>    测试&#123;&#123;a&#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>我们打印下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/template-ast.jpg" width="50%"></p><h4 id="梳理下流程"><a href="#梳理下流程" class="headerlink" title="梳理下流程"></a>梳理下流程</h4><p>以上面的模版为例，大致流程如下</p><p>while循环模版字符串，匹配完一个标签或节点，删除掉，然后继续匹配，直到字符串为空结束<br>1.从左至右，先判断&lt; 开头，说明是开头标签或者结束标签，</p><ul><li>通过正则判断是开头标签，<strong>删除掉开头标签</strong>，解析开头标签的tagName和属性attr，变成对象结构 <code>&#123;&quot;tagName&quot;: &quot;div&quot;, &quot;attrs&quot;: [&#123;&quot;name&quot;: &quot;id&quot;,&quot;value&quot;: &quot;app&quot;&#125;]&#125;</code>,继续从左至右循环，直到匹配到开头结束标签，然后删除<br>然后定义一个ast结构,并且当前节点element=<code>&#123;tag: tagName, type: 1, children: [], attrs:[],parent: null&#125;</code>对象格式，将当前节点element执行入栈操作，并且定义一个当前节点的父节点<code>currentParent=element</code></li><li>通过正则判断是结束标签，stack的最后一个肯定是当前节点即（element = stack.pop()），前一个是父节点，所以<code>currentParent=stack[stack.length - 1] , element.parent=currentParent， currentParent.children.push(element)</code>，<strong>删除结束标签</strong></li><li>如果不是&lt; 开头，肯定是文本，<strong>删除掉文本</strong>，然后解析文本：先把文本去除空格，然后 <code>currentParent.children.push(&#123;type: 3,text&#125;)</code>;</li></ul><h3 id="ast树转render字符串"><a href="#ast树转render字符串" class="headerlink" title="ast树转render字符串"></a>ast树转render字符串</h3><p>我们先看下render字符串长什么样子？<br>用如下html举例</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;font-size: 12px; color: red;&quot;</span>&gt;</span><br>  测试&#123;&#123;a&#125;&#125;<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>转换后的render字符串</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">_c</span>(<span class="hljs-string">&#x27;div&#x27;</span>,&#123;<span class="hljs-attr">id</span>:<span class="hljs-string">&quot;app&quot;</span>,<span class="hljs-attr">style</span>:&#123;<span class="hljs-string">&quot;font-size&quot;</span>:<span class="hljs-string">&quot; 12px&quot;</span>,<span class="hljs-string">&quot; color&quot;</span>:<span class="hljs-string">&quot; red&quot;</span>&#125;&#125;,<span class="hljs-title function_">_v</span>(<span class="hljs-string">&quot;测试&quot;</span>+<span class="hljs-title function_">_s</span>(a)),<span class="hljs-title function_">_c</span>(<span class="hljs-string">&#x27;h1&#x27;</span>,<span class="hljs-literal">undefined</span>,<span class="hljs-title function_">_v</span>(<span class="hljs-string">&quot;1&quot;</span>)))<br></code></pre></td></tr></table></figure><p>其中有三个函数，后面会定义，分别为<code>_c:元素 _v:文本 _s:插值表达式</code>,其中_c有是三个参数（tagName， 属性， children）</p><p>下面我们来实现上面的render字符串：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">修改src/compiler/index.<span class="hljs-property">js</span><br>...<br><span class="hljs-keyword">import</span> &#123; generate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./generate.js&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compileToFunction</span>(<span class="hljs-params">template</span>) &#123;<br>  <span class="hljs-keyword">let</span> ast = <span class="hljs-title function_">parseHTML</span>(template);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ast, <span class="hljs-string">&quot;ast&quot;</span>);<br>  <span class="hljs-comment">// 1.通过ast语法树转换成render字符串</span><br>  <span class="hljs-keyword">let</span> code=<span class="hljs-title function_">generate</span>(ast)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(code,<span class="hljs-string">&#x27;code&#x27;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs js">新增src/compiler/generate.<span class="hljs-property">js</span><br><br><span class="hljs-keyword">const</span> defaultTagRE = <span class="hljs-regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span>; <span class="hljs-comment">// 匹配双括号</span><br><br><span class="hljs-comment">// _c(&#x27;div&#x27;,&#123;id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;&#125;,,_c(&#x27;h1&#x27;,undefined,_v(&quot;1&quot;)))))</span><br><span class="hljs-comment">// _c:元素 _v:文本 _s:插值表达式 </span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">ast</span>) &#123;<br>  <span class="hljs-keyword">const</span> children = <span class="hljs-title function_">genChildren</span>(ast);  <br>  <span class="hljs-keyword">let</span> code = <span class="hljs-string">`_c(&#x27;<span class="hljs-subst">$&#123;ast.tag&#125;</span>&#x27;,<span class="hljs-subst">$&#123;</span></span><br><span class="hljs-subst"><span class="hljs-string">    ast.attrs.length ? genProps(ast.attrs) : <span class="hljs-string">&quot;undefined&quot;</span></span></span><br><span class="hljs-subst"><span class="hljs-string">  &#125;</span><span class="hljs-subst">$&#123;children ? <span class="hljs-string">`,<span class="hljs-subst">$&#123;children&#125;</span>`</span> : <span class="hljs-string">&quot;&quot;</span>&#125;</span>)`</span>;<br>  <span class="hljs-keyword">return</span> code;<br>&#125;<br><span class="hljs-comment">// 生成属性</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">genProps</span>(<span class="hljs-params">attrs</span>) &#123;<br>  <span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; attrs.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-keyword">const</span> attr = attrs[i];<br>    <span class="hljs-keyword">let</span> obj = &#123;&#125;;<br>    <span class="hljs-keyword">if</span> (attr.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;style&quot;</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(attr.<span class="hljs-property">value</span>, <span class="hljs-string">&quot;attr.value&quot;</span>); <span class="hljs-comment">// color: red;font-size: 12px</span><br>      attr.<span class="hljs-property">value</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;;&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">let</span> [key, value] = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;:&quot;</span>);<br>        obj[key] = value;<br>      &#125;);<br>      attr.<span class="hljs-property">value</span> = obj; <span class="hljs-comment">// &#123;color: red,font-size: 12px&#125;</span><br>    &#125;<br>    str += <span class="hljs-string">`<span class="hljs-subst">$&#123;attr.name&#125;</span>:<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(attr.value)&#125;</span>,`</span>;<br>  &#125;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str, <span class="hljs-string">&quot;str&quot;</span>); <span class="hljs-comment">// id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;,</span><br>  <span class="hljs-comment">// 删除最后一位逗号且前面加上大括号</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`&#123;<span class="hljs-subst">$&#123;str.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)&#125;</span>&#125;`</span>; <span class="hljs-comment">// &#123;id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;&#125;</span><br>&#125;<br><span class="hljs-comment">// 生成子节点</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">genChildren</span>(<span class="hljs-params">el</span>) &#123;<br>  <span class="hljs-keyword">let</span> children = el.<span class="hljs-property">children</span>;<br>  <span class="hljs-keyword">if</span> (children &amp;&amp; children.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">const</span> target= <span class="hljs-string">`<span class="hljs-subst">$&#123;children.map((c) =&gt; gen(c)).join(<span class="hljs-string">&quot;,&quot;</span>)&#125;</span>`</span>;<br>    <span class="hljs-keyword">return</span> target<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">gen</span>(<span class="hljs-params">el</span>) &#123;<br>    <span class="hljs-comment">// 如果是元素节点，递归调用generate</span><br>  <span class="hljs-keyword">if</span> (el.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">generate</span>(el);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">let</span> text = el.<span class="hljs-property">text</span>;<br>    <span class="hljs-comment">// 如果不是双括号的话，直接返回_v(text)</span><br>    <span class="hljs-keyword">if</span> (!defaultTagRE.<span class="hljs-title function_">test</span>(text)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(text)&#125;</span>)`</span>;<br>    &#125;<br>    <span class="hljs-comment">// 如果是双括号的话，将双括号中的内容放入tokens</span><br>    <span class="hljs-keyword">let</span> tokens = []; <span class="hljs-comment">// 存放每一段代码</span><br>    <span class="hljs-keyword">let</span> match, index; <span class="hljs-comment">// 每次匹配的结果，和匹配的索引</span><br>    <span class="hljs-keyword">let</span> lastIndex = (defaultTagRE.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>); <span class="hljs-comment">// 匹配的开始索引</span><br>    <span class="hljs-comment">// 每次匹配到的结果都放入tokens中</span><br>    <span class="hljs-keyword">while</span> ((match = defaultTagRE.<span class="hljs-title function_">exec</span>(text))) &#123;<br>      index = match.<span class="hljs-property">index</span>; <span class="hljs-comment">// 匹配到的索引</span><br>      <span class="hljs-keyword">if</span> (index &gt; lastIndex) &#123; <span class="hljs-comment">// 说明双括号前面有文本</span><br>        tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(lastIndex, index))); <span class="hljs-comment">//  双括号前面的文本</span><br>      &#125;<br>      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-string">`_s(<span class="hljs-subst">$&#123;match[<span class="hljs-number">1</span>].trim()&#125;</span>)`</span>); <span class="hljs-comment">// 双括号中的内容</span><br>      lastIndex = index + match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>; <span class="hljs-comment">// 匹配到的索引+匹配到的内容的长度</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (lastIndex &lt; text.<span class="hljs-property">length</span>) &#123; <span class="hljs-comment">// 说明双括号后面有文本</span><br>      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(lastIndex))); <span class="hljs-comment">// 双括号后面的文本</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">$&#123;tokens.join(<span class="hljs-string">&quot;+&quot;</span>)&#125;</span>)`</span>; <span class="hljs-comment">// 将tokens中的内容用+拼接</span><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>运行上面代码，即可打印出code。</p><h4 id="梳理下流程-1"><a href="#梳理下流程-1" class="headerlink" title="梳理下流程"></a>梳理下流程</h4><p>先看下ast结构</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/ast1.jpg" width="50%">,<br>我们要转换成 <code>_c(&#39;div&#39;,&#123;id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;&#125;,,_c(&#39;h1&#39;,undefined,_v(&quot;1&quot;)))))</code><br>很明显ast是个对象，我们进行如下操作</p><h4 id="第一层"><a href="#第一层" class="headerlink" title="第一层"></a>第一层</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">ast</span>) &#123;<br>  <span class="hljs-keyword">const</span> children = <span class="hljs-title function_">genChildren</span>(ast); <span class="hljs-comment">// 单独定义方法处理children</span><br>  <span class="hljs-comment">// 第一层</span><br>  <span class="hljs-keyword">let</span> code = <span class="hljs-string">`_c(&#x27;<span class="hljs-subst">$&#123;ast.tag&#125;</span>&#x27;,<span class="hljs-subst">$&#123;</span></span><br><span class="hljs-subst"><span class="hljs-string">    ast.attrs.length ? genProps(ast.attrs) : <span class="hljs-string">&quot;undefined&quot;</span> // 单独定义方法处理attrs</span></span><br><span class="hljs-subst"><span class="hljs-string">  &#125;</span><span class="hljs-subst">$&#123;children ? <span class="hljs-string">`,<span class="hljs-subst">$&#123;children&#125;</span>`</span> : <span class="hljs-string">&quot;&quot;</span>&#125;</span>)`</span>;<br>  <span class="hljs-keyword">return</span> code;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="处理attrs"><a href="#处理attrs" class="headerlink" title="处理attrs"></a>处理attrs</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js">将attrs数组转成json字符串&#123;<span class="hljs-attr">id</span>:<span class="hljs-string">&quot;app&quot;</span>,<span class="hljs-attr">style</span>:&#123;<span class="hljs-string">&quot;font-size&quot;</span>:<span class="hljs-string">&quot; 12px&quot;</span>,<span class="hljs-string">&quot; color&quot;</span>:<span class="hljs-string">&quot; red&quot;</span>&#125;&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">genProps</span>(<span class="hljs-params">attrs</span>) &#123;<br>  <span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; attrs.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-keyword">const</span> attr = attrs[i];<br>    <span class="hljs-keyword">let</span> obj = &#123;&#125;;<br>    <span class="hljs-keyword">if</span> (attr.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;style&quot;</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(attr.<span class="hljs-property">value</span>, <span class="hljs-string">&quot;attr.value&quot;</span>); <span class="hljs-comment">// color: red;font-size: 12px</span><br>      attr.<span class="hljs-property">value</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;;&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">let</span> [key, value] = item.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;:&quot;</span>);<br>        obj[key] = value;<br>      &#125;);<br>      attr.<span class="hljs-property">value</span> = obj; <span class="hljs-comment">// &#123;color: red,font-size: 12px&#125;</span><br>    &#125;<br>    str += <span class="hljs-string">`<span class="hljs-subst">$&#123;attr.name&#125;</span>:<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(attr.value)&#125;</span>,`</span>;<br>  &#125;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str, <span class="hljs-string">&quot;str&quot;</span>); <span class="hljs-comment">// id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;,</span><br>  <span class="hljs-comment">// 删除最后一位逗号且前面加上大括号</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`&#123;<span class="hljs-subst">$&#123;str.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)&#125;</span>&#125;`</span>; <span class="hljs-comment">// &#123;id:&quot;app&quot;,style:&#123;&quot;font-size&quot;:&quot; 12px&quot;,&quot; color&quot;:&quot; red&quot;&#125;&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="处理children"><a href="#处理children" class="headerlink" title="处理children"></a>处理children</h4><p>children的最终目的也是生成一个和第一步一样的结构 <code>_c(标签,属性,children)</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 生成子节点</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">genChildren</span>(<span class="hljs-params">el</span>) &#123;<br>  <span class="hljs-keyword">let</span> children = el.<span class="hljs-property">children</span>;<br>  <span class="hljs-keyword">if</span> (children &amp;&amp; children.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">const</span> target= <span class="hljs-string">`<span class="hljs-subst">$&#123;children.map((c) =&gt; gen(c)).join(<span class="hljs-string">&quot;,&quot;</span>)&#125;</span>`</span>; <span class="hljs-comment">// 循环children，对每一项判断是节点的话，重新调用第一步的generate方法，最后将数组用逗号拼接起来变成字符串</span><br>    <span class="hljs-keyword">return</span> target<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">gen</span>(<span class="hljs-params">el</span>) &#123;<br>    <span class="hljs-comment">// 如果是元素节点，递归调用generate</span><br>  <span class="hljs-keyword">if</span> (el.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">generate</span>(el);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 如果不是节点，那肯定是文本</span><br>    <span class="hljs-keyword">let</span> text = el.<span class="hljs-property">text</span>;<br>    <span class="hljs-comment">// 如果不是双括号的话，直接返回_v(text)</span><br>    <span class="hljs-keyword">if</span> (!defaultTagRE.<span class="hljs-title function_">test</span>(text)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(text)&#125;</span>)`</span>;<br>    &#125;<br>    <span class="hljs-comment">// 如果是双括号的话，将双括号中的内容放入tokens</span><br>    <span class="hljs-keyword">let</span> tokens = []; <span class="hljs-comment">// 存放每一段代码</span><br>    <span class="hljs-keyword">let</span> match, index; <span class="hljs-comment">// 每次匹配的结果，和匹配的索引</span><br>    <span class="hljs-keyword">let</span> lastIndex = (defaultTagRE.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>); <span class="hljs-comment">// 匹配的开始索引</span><br>    <span class="hljs-comment">// 每次匹配到的结果都放入tokens中</span><br>    <span class="hljs-keyword">while</span> ((match = defaultTagRE.<span class="hljs-title function_">exec</span>(text))) &#123;<br>      index = match.<span class="hljs-property">index</span>; <span class="hljs-comment">// 匹配到的索引</span><br>      <span class="hljs-keyword">if</span> (index &gt; lastIndex) &#123; <span class="hljs-comment">// 说明双括号前面有文本</span><br>        tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(lastIndex, index))); <span class="hljs-comment">//  双括号前面的文本</span><br>      &#125;<br>      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-string">`_s(<span class="hljs-subst">$&#123;match[<span class="hljs-number">1</span>].trim()&#125;</span>)`</span>); <span class="hljs-comment">// 双括号中的内容</span><br>      lastIndex = index + match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>; <span class="hljs-comment">// 匹配到的索引+匹配到的内容的长度</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (lastIndex &lt; text.<span class="hljs-property">length</span>) &#123; <span class="hljs-comment">// 说明双括号后面有文本</span><br>      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(lastIndex))); <span class="hljs-comment">// 双括号后面的文本</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">$&#123;tokens.join(<span class="hljs-string">&quot;+&quot;</span>)&#125;</span>)`</span>; <span class="hljs-comment">// 将tokens中的内容用+拼接</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="render字符串转render函数"><a href="#render字符串转render函数" class="headerlink" title="render字符串转render函数"></a>render字符串转render函数</h3><p>转函数很简单，我们用函数包装起来即可</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">修改src/compiler/index.<span class="hljs-property">js</span><br>...<br><span class="hljs-keyword">import</span> &#123; generate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./generate.js&quot;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compileToFunction</span>(<span class="hljs-params">template</span>) &#123;<br>  ...<br>  <span class="hljs-keyword">let</span> code=<span class="hljs-title function_">generate</span>(ast)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(code,<span class="hljs-string">&#x27;code&#x27;</span>)<br>  <span class="hljs-comment">// 3.通过new Function + with来生成render函数</span><br>  <span class="hljs-keyword">let</span> render = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">`with(this)&#123;return <span class="hljs-subst">$&#123;code&#125;</span>&#125;`</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(render,<span class="hljs-string">&#x27;render&#x27;</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>()); <span class="hljs-comment">// 注意，没什么用，这里只是为了看下随便打印个函数是啥样子的</span><br>  <span class="hljs-keyword">return</span> render <span class="hljs-comment">// render出去，调用compileToFunction的地方用</span><br>&#125;<br></code></pre></td></tr></table></figure><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/render.jpg" width="50%"><h4 id="with"><a href="#with" class="headerlink" title="with"></a>with</h4><p>我们发现上面除去定义一个函数，还使用了<code>with函数</code>，这个是干啥的？我们先了解下什么是with函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> obj=&#123;<br>  <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,<br>  <span class="hljs-attr">b</span>:<span class="hljs-number">2</span><br>&#125;<br><span class="hljs-title function_">with</span>(<span class="hljs-params">obj</span>)&#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">a</span>) <span class="hljs-comment">// 1 </span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">// 1</span><br>&#125;<br></code></pre></td></tr></table></figure><p>上面代码会自执行,执行上面代码直接会执行with函数中的代码打印<br>**with函数是将代码的作用域设置到一个特定的作用域中(即with(作用域))**，此时函数内我们可以省略<code>obj.</code>，直接拿到属性值，注意：</p><ul><li>with函数已弃用，strict不能使用，会报错</li><li>with函数是早期的js函数，兼容所有浏览器，包括ie6</li><li>ES6模块（如定一个函数，使用了导入导出，或者es6的Class）自带严格模式，不管你有没有在模块头部加上”use strict”，所以不能使用with</li></ul><p>了解了with函数的作用，我们可以想下我们上面定义了<code>_c:元素 _v:文本 _s:插值表达式</code>,这三个函数是直接使用的，但window上没有该方法啊，<br>所以这三个方法肯定定义到vue的原型链上了，所以我们将this传入到with(this)中，就可以直接使用了。</p><h2 id="render转vdom"><a href="#render转vdom" class="headerlink" title="render转vdom"></a>render转vdom</h2><h3 id="vdom和ast区别"><a href="#vdom和ast区别" class="headerlink" title="vdom和ast区别"></a>vdom和ast区别</h3><p>我们先看下vdom是啥样子的？<br>还是用如下html举例</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;font-size: 12px; color: red;&quot;</span>&gt;</span><br>  测试&#123;&#123;a&#125;&#125;<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// ast</span><br>&#123;<br>  <span class="hljs-attr">type</span>:<span class="hljs-number">1</span>,<br>  <span class="hljs-attr">parent</span>:<span class="hljs-literal">null</span>,<br>  <span class="hljs-attr">tag</span>: <span class="hljs-string">&quot;div&quot;</span>,<br>  <span class="hljs-attr">attrs</span>:[<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;id&quot;</span>,<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;app&quot;</span><br>    &#125;,<br>    &#123;<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;style&quot;</span>,<br>        <span class="hljs-string">&quot;value&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;font-size&quot;</span>: <span class="hljs-string">&quot;12px&quot;</span>,<br>            <span class="hljs-string">&quot;color&quot;</span>: <span class="hljs-string">&quot;red&quot;</span><br>        &#125;<br>    &#125;<br>  ],<br>  <span class="hljs-attr">children</span>:[<br>    &#123;<span class="hljs-attr">type</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;测试&#123;&#123;a&#125;&#125;&#x27;</span>&#125;,<br>    &#123;<span class="hljs-attr">tag</span>: <span class="hljs-string">&#x27;h1&#x27;</span>, <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">children</span>: [&#123;<span class="hljs-attr">type</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;1&#x27;</span>&#125;], <span class="hljs-attr">attrs</span>: [], <span class="hljs-attr">parent</span>:<span class="hljs-literal">null</span>&#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// vdom</span><br>&#123;<br>  <span class="hljs-attr">tag</span>: <span class="hljs-string">&quot;div&quot;</span>,<br>  <span class="hljs-attr">data</span>:&#123;<br>    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;app&quot;</span>,<br>    <span class="hljs-string">&quot;style&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;font-size&quot;</span>: <span class="hljs-string">&quot;12px&quot;</span>,<br>        <span class="hljs-string">&quot;color&quot;</span>: <span class="hljs-string">&quot;red&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">children</span>:[<br>   &#123;<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;测试1&quot;</span>,<span class="hljs-attr">data</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">key</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">tag</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">children</span>:<span class="hljs-literal">undefined</span>&#125;,<br>   &#123;<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-literal">undefined</span>,<span class="hljs-attr">data</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">key</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">tag</span>:<span class="hljs-string">&quot;h1&quot;</span>,<span class="hljs-attr">children</span>:[&#123;<span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-attr">data</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">key</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">tag</span>:<span class="hljs-literal">undefined</span>,<span class="hljs-attr">children</span>:<span class="hljs-literal">undefined</span>&#125;]&#125;<br>  ],<br>  <span class="hljs-attr">key</span>:<span class="hljs-string">&quot;key&quot;</span>,<br>  <span class="hljs-attr">text</span>:文本节点<br>&#125;<br><br></code></pre></td></tr></table></figure><p>我们发现实际上ast和vdom很像，区别是：</p><ul><li>实际上ast很复杂，本例子中只是主流程，ast含有其他属性，如start、end等</li><li>vdom和ast都是树结构，只不过vdom相当于ast的格式化结构</li><li>下面会讲到，vdom转化成真实dom，会调用createElm方法（此时vdom会多了一个el属性，其值是通过createElement或者createTextNode创建的真实dom节点）。</li><li><strong>vdom的模版变量值已经变成了真实的值，并不是ast的<code>测试&#123;&#123;a&#125;&#125;</code>,而是 <code>测试1</code></strong></li></ul><p>下面我们来实现下：</p><h3 id="render转vdom-1"><a href="#render转vdom-1" class="headerlink" title="render转vdom"></a>render转vdom</h3><p>实际上我们的render执行的值就是vdom，只不过里面的<code>_c:元素 _v:文本 _s:插值表达式</code>三个方法尚未实现。render函数的作用：创建虚拟dom，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-number">1.</span>修改src/init.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">import</span> &#123; mountComponent &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./lifecycle&quot;</span>;<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) &#123;<br>      ...<br>      <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">render</span>) &#123;<br>        ...<br>      &#125;<br>      <span class="hljs-comment">// 1.将render方法挂载到options上</span><br>      <span class="hljs-keyword">const</span> render = <span class="hljs-title function_">compileToFunction</span>(template);<br>      options.<span class="hljs-property">render</span> = render;<br>    &#125;<br>    <span class="hljs-comment">// 2.挂载组件（主要用到_update和_render方法）</span><br>    <span class="hljs-title function_">mountComponent</span>(vm, el);<br>  &#125;;<br><br><span class="hljs-number">2.</span>新建src/lifecycle.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">import</span> &#123; patch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./vdom/patch&quot;</span>;<br>  <span class="hljs-comment">// 3.创建挂载组件方法</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span>(<span class="hljs-params">vm, el</span>) &#123;<br>    <span class="hljs-comment">// 4.调用vm._render函数，生成虚拟dom </span><br>    <span class="hljs-keyword">const</span> vnode=vm.<span class="hljs-title function_">_render</span>()<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(vode,<span class="hljs-string">&#x27;vnode&#x27;</span>)<br>    <span class="hljs-keyword">return</span> vnode <span class="hljs-comment">// return出去，后面转换真实dom用</span><br>  &#125;<br><span class="hljs-number">3.</span>新建src/vdom/index.<span class="hljs-property">js</span><br>  <span class="hljs-comment">// 5.创建render混入函数</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>    <span class="hljs-comment">// vue原型增加_render函数生成虚拟dom</span><br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_render</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>      <span class="hljs-comment">// 取出之前放到options上的render方法</span><br>      <span class="hljs-keyword">const</span> &#123; render &#125; = vm.<span class="hljs-property">$options</span>;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(render, <span class="hljs-string">&quot;render&quot;</span>);<br>      <span class="hljs-keyword">let</span> vnode = render.<span class="hljs-title function_">call</span>(vm); <span class="hljs-comment">// 将vm指向当前实例，传给with函数,此时模版中的变量已经可以拿到值</span><br>      <span class="hljs-keyword">return</span> vnode;<br>    &#125;;<br>    <span class="hljs-comment">// 标签转换成虚拟dom(_c(&#x27;div&#x27;,&#123;&#125;,&#x27;hello&#x27;,&#x27;hello1&#x27;))</span><br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_c</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">createElement</span>(...<span class="hljs-variable language_">arguments</span>);<br>    &#125;;<br>    <span class="hljs-comment">// 变量(_s(变量))</span><br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_s</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) &#123;        <br>      <span class="hljs-comment">// 如果是对象，转换成字符串，如果是null或者undefined返回空,注意null==undefined为true，null===undefined为false，所以如果val为undefined也为&#x27;&#x27;</span><br>      <span class="hljs-keyword">return</span> val == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">&quot;object&quot;</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(val) : val;<br>    &#125;;<br>    <span class="hljs-comment">// 文本</span><br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_v</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">createTextVnode</span>(text);<br>    &#125;;<br>  &#125;<br>  <span class="hljs-comment">// 构造虚拟dom结构</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">vnode</span>(<span class="hljs-params">tag, data, key, children, text</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      tag,<br>      data,<br>      key,<br>      children,<br>      text,<br>    &#125;;<br>  &#125;<br>  <span class="hljs-comment">// 创建虚拟dom（之前_c的参数：tag,data,多个子节点）</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">tag, data = &#123;&#125;, ...children</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vnode</span>(tag, data, data.<span class="hljs-property">key</span>, children);<br>  &#125;<br>  <span class="hljs-comment">// 创建文本虚拟dom</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextVnode</span>(<span class="hljs-params">text</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">vnode</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-literal">undefined</span>, text);<br>  &#125;<br><span class="hljs-number">4.</span>修改src/index.<span class="hljs-property">js</span><br><span class="hljs-keyword">import</span> &#123; initMixin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./init&quot;</span>;<br><span class="hljs-comment">// 6.将上面定义的vue原型方法混入</span><br><span class="hljs-keyword">import</span> &#123; renderMixin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./vdom/index&quot;</span>;<br>...<br><span class="hljs-title function_">initMixin</span>(<span class="hljs-title class_">Vue</span>)<br><span class="hljs-title function_">renderMixin</span>(<span class="hljs-title class_">Vue</span>) <span class="hljs-comment">// 添加render</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Vue</span>;<br><br></code></pre></td></tr></table></figure><p>我们打印下，可以看到vnode<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/vnode.jpg" width="50%"></p><p>我们可以发现之前的模版都已经变成data上定义的值，但是我们前面讲的vdom上面最重要的属性还没有实现（图上的el属性有是因为用的包含转真实dom的代码运行的）。因为该属性和转<br>真实dom是一起的，所以放到下面讲。</p><h3 id="vdom转真实dom"><a href="#vdom转真实dom" class="headerlink" title="vdom转真实dom"></a>vdom转真实dom</h3><p>现在我们要把vdom更新到页面上</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-number">1.</span>修改src/init.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">import</span> &#123; mountComponent &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./lifecycle&quot;</span>;<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el</span>) &#123;<br>      ...<br>      vm.<span class="hljs-property">$el</span> = el; <span class="hljs-comment">// 1.存储当前组件的根元素，用于后续的vdom转换真实dom操作</span><br>      <span class="hljs-keyword">if</span> (!options.<span class="hljs-property">render</span>) &#123;<br>        ...<br>      &#125;<br>      ...<br>    &#125;<br>    ...<br>  &#125;;<br><span class="hljs-number">2.</span>修改src/lifecycle.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">import</span> &#123; patch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./vdom/patch&quot;</span>;<br>  <span class="hljs-comment">// 挂载组件</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span>(<span class="hljs-params">vm, el</span>) &#123;<br>    <span class="hljs-comment">// render--&gt;vnode--&gt;真实dom</span><br>    <span class="hljs-comment">// 2.调用vm._render函数，生成虚拟dom 2.调用vm._update,将虚拟dom转换成真实dom</span><br>    vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>());<br>  &#125;<br>  <span class="hljs-comment">// 3.新增生命周期方法混入</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">lifecycleMixin</span>(<span class="hljs-params">Vue</span>) &#123;<br>    <span class="hljs-comment">// 4.增加更新方法</span><br>    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_update</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">vnode</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(vnode, <span class="hljs-string">&quot;vnode&quot;</span>);<br>      <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>;<br>      <span class="hljs-comment">// 5. 增加渲染真实dom方法patch</span><br>      <span class="hljs-comment">// 两个参数，第一个是老的dom节点，第二个是新的虚拟节点(用新的vnodes来生成新的dom，替换掉老的dom)，然后重新绑定到vm.$el上    </span><br>      vm.<span class="hljs-property">$el</span> = <span class="hljs-title function_">patch</span>(vm.<span class="hljs-property">$el</span>, vnode);<br>    &#125;;<br>  &#125;<br><span class="hljs-number">3.</span>修改src/index.<span class="hljs-property">js</span><br>  <span class="hljs-keyword">import</span> &#123; initMixin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./init&quot;</span>;<br>  <span class="hljs-comment">// 6.将上面定义的vue原型方法混入</span><br>  <span class="hljs-keyword">import</span> &#123; lifecycleMixin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./vdom/index&quot;</span>;<br>  ...<br>  <span class="hljs-title function_">initMixin</span>(<span class="hljs-title class_">Vue</span>)<br>  <span class="hljs-title function_">renderMixin</span>(<span class="hljs-title class_">Vue</span>) <span class="hljs-comment">// 添加render</span><br>  <span class="hljs-title function_">lifecycleMixin</span>(<span class="hljs-title class_">Vue</span>) <span class="hljs-comment">// 添加lifecycle</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Vue</span>;<br><br><span class="hljs-number">4.</span>增加src/vdom/patch.<span class="hljs-property">js</span><br>  <span class="hljs-comment">// 7.定义patch方法</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldnode, vnode</span>) &#123;<br>    <span class="hljs-keyword">const</span> oldElm = oldnode; <span class="hljs-comment">// div id=&quot;app&quot;</span><br>    <span class="hljs-keyword">const</span> parentElm = oldElm.<span class="hljs-property">parentNode</span>; <span class="hljs-comment">// body</span><br>    <span class="hljs-keyword">let</span> el = <span class="hljs-title function_">createElm</span>(vnode); <span class="hljs-comment">// 创建真实dom</span><br>    <span class="hljs-comment">// insertBefore(a,b)表示将a插入到b前面， a.nextSibling表示a节点后面下一个兄弟节点</span><br>    parentElm.<span class="hljs-title function_">insertBefore</span>(el, oldElm.<span class="hljs-property">nextSibling</span>); <span class="hljs-comment">// 将创建的真实dom插入到body中（即app后面）</span><br>    parentElm.<span class="hljs-title function_">removeChild</span>(oldElm); <span class="hljs-comment">// 删除原来的div即app</span><br>    <span class="hljs-keyword">return</span> el;<br>  &#125;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElm</span>(<span class="hljs-params">vnode</span>) &#123;<br>    <span class="hljs-keyword">let</span> &#123; tag, children, key, data, text &#125; = vnode;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> tag === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>      <span class="hljs-comment">// 元素</span><br>      vnode.<span class="hljs-property">el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(tag); <span class="hljs-comment">// 创建元素</span><br>      children.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> &#123;<br>        vnode.<span class="hljs-property">el</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElm</span>(child)); <span class="hljs-comment">// 递归渲染子节点</span><br>      &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 文本</span><br>      vnode.<span class="hljs-property">el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(text);<br>    &#125;  <br>    <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">el</span>;<br>  &#125;<br><br></code></pre></td></tr></table></figure><p>至此，我们已经实现了初次渲染。但上面只是粗暴的删除app节点，插入新的节点，后面会讲到diff。我们可以看到页面，已经更新。</p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="images/rdom.jpg" width="50%"><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>vue的大致渲染流程<br><code>数据初始化-&gt;模版编译-&gt;render-&gt;vdom-&gt;dom -&gt;放到页面</code></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mystylemylife.github.io/ypf-blog">ypf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mystylemylife.github.io/ypf-blog/2023/07/11/vue2%E6%BA%90%E7%A0%81/4.%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91/">https://mystylemylife.github.io/ypf-blog/2023/07/11/vue2%E6%BA%90%E7%A0%81/4.%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mystylemylife.github.io/ypf-blog" target="_blank">ypf的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/ypf-blog/2023/07/19/vue2%E6%BA%90%E7%A0%81/5.%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8Cvue.mixin/" title="5.生命周期和vue.mixin"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">5.生命周期和vue.mixin</div></div></a></div><div class="next-post pull-right"><a href="/ypf-blog/2023/06/12/vue2%E6%BA%90%E7%A0%81/3.%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81-%E6%95%B0%E7%BB%84/" title="3.数据劫持-数组"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">3.数据劫持-数组</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.</span> <span class="toc-text">生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vue%E5%A4%A7%E8%87%B4%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">vue大致渲染流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E8%8A%82%E8%A6%81%E8%AE%B2%E7%9A%84%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">本节要讲的模版编译的流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96template"><span class="toc-number">2.</span> <span class="toc-text">获取template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#template%E5%8F%98%E6%88%90render"><span class="toc-number">3.</span> <span class="toc-text">template变成render</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#template%E5%8F%98%E6%88%90ast"><span class="toc-number">3.1.</span> <span class="toc-text">template变成ast</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vue-template-compiler%E5%8C%85"><span class="toc-number">3.1.1.</span> <span class="toc-text">vue-template-compiler包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#astexplorer"><span class="toc-number">3.1.2.</span> <span class="toc-text">astexplorer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%BC%96%E5%86%99"><span class="toc-number">3.1.3.</span> <span class="toc-text">自己编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E4%B8%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.4.</span> <span class="toc-text">梳理下流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast%E6%A0%91%E8%BD%ACrender%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.2.</span> <span class="toc-text">ast树转render字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A2%B3%E7%90%86%E4%B8%8B%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">梳理下流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%B1%82"><span class="toc-number">3.2.2.</span> <span class="toc-text">第一层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86attrs"><span class="toc-number">3.2.3.</span> <span class="toc-text">处理attrs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86children"><span class="toc-number">3.2.4.</span> <span class="toc-text">处理children</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%ACrender%E5%87%BD%E6%95%B0"><span class="toc-number">3.3.</span> <span class="toc-text">render字符串转render函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#with"><span class="toc-number">3.3.1.</span> <span class="toc-text">with</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#render%E8%BD%ACvdom"><span class="toc-number">4.</span> <span class="toc-text">render转vdom</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vdom%E5%92%8Cast%E5%8C%BA%E5%88%AB"><span class="toc-number">4.1.</span> <span class="toc-text">vdom和ast区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#render%E8%BD%ACvdom-1"><span class="toc-number">4.2.</span> <span class="toc-text">render转vdom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vdom%E8%BD%AC%E7%9C%9F%E5%AE%9Edom"><span class="toc-number">4.3.</span> <span class="toc-text">vdom转真实dom</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By ypf</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/main.min.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/mystylemylife/ypf-blog/assets/js/code-collapse.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/hexo-theme-butterfly@4.13.0/source/js/search/local-search.min.js"></script></div></div></body></html>